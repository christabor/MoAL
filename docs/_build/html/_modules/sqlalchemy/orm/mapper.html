

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>sqlalchemy.orm.mapper &mdash; MoAL  documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="MoAL  documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> MoAL
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../MOAL.html">MOAL package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../index.html">MoAL</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      
    <li>sqlalchemy.orm.mapper</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for sqlalchemy.orm.mapper</h1><div class="highlight"><pre>
<span class="c"># orm/mapper.py</span>
<span class="c"># Copyright (C) 2005-2015 the SQLAlchemy authors and contributors</span>
<span class="c"># &lt;see AUTHORS file&gt;</span>
<span class="c">#</span>
<span class="c"># This module is part of SQLAlchemy and is released under</span>
<span class="c"># the MIT License: http://www.opensource.org/licenses/mit-license.php</span>

<span class="sd">&quot;&quot;&quot;Logic to map Python classes to and from selectables.</span>

<span class="sd">Defines the :class:`~sqlalchemy.orm.mapper.Mapper` class, the central</span>
<span class="sd">configurational unit which associates a class with a database table.</span>

<span class="sd">This is a semi-private module; the main configurational API of the ORM is</span>
<span class="sd">available in :class:`~sqlalchemy.orm.`.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">weakref</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span>

<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">sql</span><span class="p">,</span> <span class="n">util</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">exc</span> <span class="k">as</span> <span class="n">sa_exc</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">inspection</span>
<span class="kn">from</span> <span class="nn">..sql</span> <span class="kn">import</span> <span class="n">expression</span><span class="p">,</span> <span class="n">visitors</span><span class="p">,</span> <span class="n">operators</span><span class="p">,</span> <span class="n">util</span> <span class="k">as</span> <span class="n">sql_util</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">instrumentation</span><span class="p">,</span> <span class="n">attributes</span><span class="p">,</span> <span class="n">exc</span> <span class="k">as</span> <span class="n">orm_exc</span><span class="p">,</span> <span class="n">loading</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">properties</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">util</span> <span class="k">as</span> <span class="n">orm_util</span>
<span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">MapperProperty</span><span class="p">,</span> <span class="n">InspectionAttr</span><span class="p">,</span> <span class="n">_MappedAttribute</span>

<span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">_class_to_mapper</span><span class="p">,</span> <span class="n">_state_mapper</span><span class="p">,</span> <span class="n">class_mapper</span><span class="p">,</span> \
    <span class="n">state_str</span><span class="p">,</span> <span class="n">_INSTRUMENTOR</span>
<span class="kn">from</span> <span class="nn">.path_registry</span> <span class="kn">import</span> <span class="n">PathRegistry</span>

<span class="kn">import</span> <span class="nn">sys</span>


<span class="n">_mapper_registry</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">()</span>
<span class="n">_already_compiling</span> <span class="o">=</span> <span class="bp">False</span>

<span class="n">_memoized_configured_property</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">group_expirable_memoized_property</span><span class="p">()</span>


<span class="c"># a constant returned by _get_attr_by_column to indicate</span>
<span class="c"># this mapper is not handling an attribute for a particular</span>
<span class="c"># column</span>
<span class="n">NO_ATTRIBUTE</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">symbol</span><span class="p">(</span><span class="s">&#39;NO_ATTRIBUTE&#39;</span><span class="p">)</span>

<span class="c"># lock used to synchronize the &quot;mapper configure&quot; step</span>
<span class="n">_CONFIGURE_MUTEX</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>


<span class="nd">@inspection._self_inspects</span>
<span class="nd">@log.class_logger</span>
<span class="k">class</span> <span class="nc">Mapper</span><span class="p">(</span><span class="n">InspectionAttr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Define the correlation of class attributes to database table</span>
<span class="sd">    columns.</span>

<span class="sd">    The :class:`.Mapper` object is instantiated using the</span>
<span class="sd">    :func:`~sqlalchemy.orm.mapper` function.    For information</span>
<span class="sd">    about instantiating new :class:`.Mapper` objects, see</span>
<span class="sd">    that function&#39;s documentation.</span>


<span class="sd">    When :func:`.mapper` is used</span>
<span class="sd">    explicitly to link a user defined class with table</span>
<span class="sd">    metadata, this is referred to as *classical mapping*.</span>
<span class="sd">    Modern SQLAlchemy usage tends to favor the</span>
<span class="sd">    :mod:`sqlalchemy.ext.declarative` extension for class</span>
<span class="sd">    configuration, which</span>
<span class="sd">    makes usage of :func:`.mapper` behind the scenes.</span>

<span class="sd">    Given a particular class known to be mapped by the ORM,</span>
<span class="sd">    the :class:`.Mapper` which maintains it can be acquired</span>
<span class="sd">    using the :func:`.inspect` function::</span>

<span class="sd">        from sqlalchemy import inspect</span>

<span class="sd">        mapper = inspect(MyClass)</span>

<span class="sd">    A class which was mapped by the :mod:`sqlalchemy.ext.declarative`</span>
<span class="sd">    extension will also have its mapper available via the ``__mapper__``</span>
<span class="sd">    attribute.</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_new_mappers</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">class_</span><span class="p">,</span>
                 <span class="n">local_table</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">properties</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">primary_key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">non_primary</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">inherits</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">inherit_condition</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">inherit_foreign_keys</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">extension</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">order_by</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">always_refresh</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">version_id_col</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">version_id_generator</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">polymorphic_on</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">_polymorphic_map</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">polymorphic_identity</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">concrete</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">with_polymorphic</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">allow_partial_pks</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="n">batch</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="n">column_prefix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">include_properties</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">exclude_properties</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">passive_updates</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="n">confirm_deleted_rows</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="n">eager_defaults</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">legacy_is_orphan</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">_compiled_cache_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                 <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a new :class:`~.Mapper` object.</span>

<span class="sd">        This function is typically used behind the scenes</span>
<span class="sd">        via the Declarative extension.   When using Declarative,</span>
<span class="sd">        many of the usual :func:`.mapper` arguments are handled</span>
<span class="sd">        by the Declarative extension itself, including ``class_``,</span>
<span class="sd">        ``local_table``, ``properties``, and  ``inherits``.</span>
<span class="sd">        Other options are passed to :func:`.mapper` using</span>
<span class="sd">        the ``__mapper_args__`` class variable::</span>

<span class="sd">           class MyClass(Base):</span>
<span class="sd">               __tablename__ = &#39;my_table&#39;</span>
<span class="sd">               id = Column(Integer, primary_key=True)</span>
<span class="sd">               type = Column(String(50))</span>
<span class="sd">               alt = Column(&quot;some_alt&quot;, Integer)</span>

<span class="sd">               __mapper_args__ = {</span>
<span class="sd">                   &#39;polymorphic_on&#39; : type</span>
<span class="sd">               }</span>


<span class="sd">        Explicit use of :func:`.mapper`</span>
<span class="sd">        is often referred to as *classical mapping*.  The above</span>
<span class="sd">        declarative example is equivalent in classical form to::</span>

<span class="sd">            my_table = Table(&quot;my_table&quot;, metadata,</span>
<span class="sd">                Column(&#39;id&#39;, Integer, primary_key=True),</span>
<span class="sd">                Column(&#39;type&#39;, String(50)),</span>
<span class="sd">                Column(&quot;some_alt&quot;, Integer)</span>
<span class="sd">            )</span>

<span class="sd">            class MyClass(object):</span>
<span class="sd">                pass</span>

<span class="sd">            mapper(MyClass, my_table,</span>
<span class="sd">                polymorphic_on=my_table.c.type,</span>
<span class="sd">                properties={</span>
<span class="sd">                    &#39;alt&#39;:my_table.c.some_alt</span>
<span class="sd">                })</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            :ref:`classical_mapping` - discussion of direct usage of</span>
<span class="sd">            :func:`.mapper`</span>

<span class="sd">        :param class\_: The class to be mapped.  When using Declarative,</span>
<span class="sd">          this argument is automatically passed as the declared class</span>
<span class="sd">          itself.</span>

<span class="sd">        :param local_table: The :class:`.Table` or other selectable</span>
<span class="sd">           to which the class is mapped.  May be ``None`` if</span>
<span class="sd">           this mapper inherits from another mapper using single-table</span>
<span class="sd">           inheritance.   When using Declarative, this argument is</span>
<span class="sd">           automatically passed by the extension, based on what</span>
<span class="sd">           is configured via the ``__table__`` argument or via the</span>
<span class="sd">           :class:`.Table` produced as a result of the ``__tablename__``</span>
<span class="sd">           and :class:`.Column` arguments present.</span>

<span class="sd">        :param always_refresh: If True, all query operations for this mapped</span>
<span class="sd">           class will overwrite all data within object instances that already</span>
<span class="sd">           exist within the session, erasing any in-memory changes with</span>
<span class="sd">           whatever information was loaded from the database. Usage of this</span>
<span class="sd">           flag is highly discouraged; as an alternative, see the method</span>
<span class="sd">           :meth:`.Query.populate_existing`.</span>

<span class="sd">        :param allow_partial_pks: Defaults to True.  Indicates that a</span>
<span class="sd">           composite primary key with some NULL values should be considered as</span>
<span class="sd">           possibly existing within the database. This affects whether a</span>
<span class="sd">           mapper will assign an incoming row to an existing identity, as well</span>
<span class="sd">           as if :meth:`.Session.merge` will check the database first for a</span>
<span class="sd">           particular primary key value. A &quot;partial primary key&quot; can occur if</span>
<span class="sd">           one has mapped to an OUTER JOIN, for example.</span>

<span class="sd">        :param batch: Defaults to ``True``, indicating that save operations</span>
<span class="sd">           of multiple entities can be batched together for efficiency.</span>
<span class="sd">           Setting to False indicates</span>
<span class="sd">           that an instance will be fully saved before saving the next</span>
<span class="sd">           instance.  This is used in the extremely rare case that a</span>
<span class="sd">           :class:`.MapperEvents` listener requires being called</span>
<span class="sd">           in between individual row persistence operations.</span>

<span class="sd">        :param column_prefix: A string which will be prepended</span>
<span class="sd">           to the mapped attribute name when :class:`.Column`</span>
<span class="sd">           objects are automatically assigned as attributes to the</span>
<span class="sd">           mapped class.  Does not affect explicitly specified</span>
<span class="sd">           column-based properties.</span>

<span class="sd">           See the section :ref:`column_prefix` for an example.</span>

<span class="sd">        :param concrete: If True, indicates this mapper should use concrete</span>
<span class="sd">           table inheritance with its parent mapper.</span>

<span class="sd">           See the section :ref:`concrete_inheritance` for an example.</span>

<span class="sd">        :param confirm_deleted_rows: defaults to True; when a DELETE occurs</span>
<span class="sd">          of one more rows based on specific primary keys, a warning is</span>
<span class="sd">          emitted when the number of rows matched does not equal the number</span>
<span class="sd">          of rows expected.  This parameter may be set to False to handle the</span>
<span class="sd">          case where database ON DELETE CASCADE rules may be deleting some of</span>
<span class="sd">          those rows automatically.  The warning may be changed to an</span>
<span class="sd">          exception in a future release.</span>

<span class="sd">          .. versionadded:: 0.9.4 - added</span>
<span class="sd">             :paramref:`.mapper.confirm_deleted_rows` as well as conditional</span>
<span class="sd">             matched row checking on delete.</span>

<span class="sd">        :param eager_defaults: if True, the ORM will immediately fetch the</span>
<span class="sd">          value of server-generated default values after an INSERT or UPDATE,</span>
<span class="sd">          rather than leaving them as expired to be fetched on next access.</span>
<span class="sd">          This can be used for event schemes where the server-generated values</span>
<span class="sd">          are needed immediately before the flush completes.   By default,</span>
<span class="sd">          this scheme will emit an individual ``SELECT`` statement per row</span>
<span class="sd">          inserted or updated, which note can add significant performance</span>
<span class="sd">          overhead.  However, if the</span>
<span class="sd">          target database supports :term:`RETURNING`, the default values will</span>
<span class="sd">          be returned inline with the INSERT or UPDATE statement, which can</span>
<span class="sd">          greatly enhance performance for an application that needs frequent</span>
<span class="sd">          access to just-generated server defaults.</span>

<span class="sd">          .. versionchanged:: 0.9.0 The ``eager_defaults`` option can now</span>
<span class="sd">             make use of :term:`RETURNING` for backends which support it.</span>

<span class="sd">        :param exclude_properties: A list or set of string column names to</span>
<span class="sd">          be excluded from mapping.</span>

<span class="sd">          See :ref:`include_exclude_cols` for an example.</span>

<span class="sd">        :param extension: A :class:`.MapperExtension` instance or</span>
<span class="sd">           list of :class:`.MapperExtension` instances which will be applied</span>
<span class="sd">           to all operations by this :class:`.Mapper`.  **Deprecated.**</span>
<span class="sd">           Please see :class:`.MapperEvents`.</span>

<span class="sd">        :param include_properties: An inclusive list or set of string column</span>
<span class="sd">          names to map.</span>

<span class="sd">          See :ref:`include_exclude_cols` for an example.</span>

<span class="sd">        :param inherits: A mapped class or the corresponding :class:`.Mapper`</span>
<span class="sd">          of one indicating a superclass to which this :class:`.Mapper`</span>
<span class="sd">          should *inherit* from.   The mapped class here must be a subclass</span>
<span class="sd">          of the other mapper&#39;s class.   When using Declarative, this argument</span>
<span class="sd">          is passed automatically as a result of the natural class</span>
<span class="sd">          hierarchy of the declared classes.</span>

<span class="sd">          .. seealso::</span>

<span class="sd">            :ref:`inheritance_toplevel`</span>

<span class="sd">        :param inherit_condition: For joined table inheritance, a SQL</span>
<span class="sd">           expression which will</span>
<span class="sd">           define how the two tables are joined; defaults to a natural join</span>
<span class="sd">           between the two tables.</span>

<span class="sd">        :param inherit_foreign_keys: When ``inherit_condition`` is used and</span>
<span class="sd">           the columns present are missing a :class:`.ForeignKey`</span>
<span class="sd">           configuration, this parameter can be used to specify which columns</span>
<span class="sd">           are &quot;foreign&quot;.  In most cases can be left as ``None``.</span>

<span class="sd">        :param legacy_is_orphan: Boolean, defaults to ``False``.</span>
<span class="sd">          When ``True``, specifies that &quot;legacy&quot; orphan consideration</span>
<span class="sd">          is to be applied to objects mapped by this mapper, which means</span>
<span class="sd">          that a pending (that is, not persistent) object is auto-expunged</span>
<span class="sd">          from an owning :class:`.Session` only when it is de-associated</span>
<span class="sd">          from *all* parents that specify a ``delete-orphan`` cascade towards</span>
<span class="sd">          this mapper.  The new default behavior is that the object is</span>
<span class="sd">          auto-expunged when it is de-associated with *any* of its parents</span>
<span class="sd">          that specify ``delete-orphan`` cascade.  This behavior is more</span>
<span class="sd">          consistent with that of a persistent object, and allows behavior to</span>
<span class="sd">          be consistent in more scenarios independently of whether or not an</span>
<span class="sd">          orphanable object has been flushed yet or not.</span>

<span class="sd">          See the change note and example at :ref:`legacy_is_orphan_addition`</span>
<span class="sd">          for more detail on this change.</span>

<span class="sd">          .. versionadded:: 0.8 - the consideration of a pending object as</span>
<span class="sd">            an &quot;orphan&quot; has been modified to more closely match the</span>
<span class="sd">            behavior as that of persistent objects, which is that the object</span>
<span class="sd">            is expunged from the :class:`.Session` as soon as it is</span>
<span class="sd">            de-associated from any of its orphan-enabled parents.  Previously,</span>
<span class="sd">            the pending object would be expunged only if de-associated</span>
<span class="sd">            from all of its orphan-enabled parents. The new flag</span>
<span class="sd">            ``legacy_is_orphan`` is added to :func:`.orm.mapper` which</span>
<span class="sd">            re-establishes the legacy behavior.</span>

<span class="sd">        :param non_primary: Specify that this :class:`.Mapper` is in addition</span>
<span class="sd">          to the &quot;primary&quot; mapper, that is, the one used for persistence.</span>
<span class="sd">          The :class:`.Mapper` created here may be used for ad-hoc</span>
<span class="sd">          mapping of the class to an alternate selectable, for loading</span>
<span class="sd">          only.</span>

<span class="sd">          :paramref:`.Mapper.non_primary` is not an often used option, but</span>
<span class="sd">          is useful in some specific :func:`.relationship` cases.</span>

<span class="sd">          .. seealso::</span>

<span class="sd">              :ref:`relationship_non_primary_mapper`</span>

<span class="sd">        :param order_by: A single :class:`.Column` or list of :class:`.Column`</span>
<span class="sd">           objects for which selection operations should use as the default</span>
<span class="sd">           ordering for entities.  By default mappers have no pre-defined</span>
<span class="sd">           ordering.</span>

<span class="sd">        :param passive_updates: Indicates UPDATE behavior of foreign key</span>
<span class="sd">           columns when a primary key column changes on a joined-table</span>
<span class="sd">           inheritance mapping.   Defaults to ``True``.</span>

<span class="sd">           When True, it is assumed that ON UPDATE CASCADE is configured on</span>
<span class="sd">           the foreign key in the database, and that the database will handle</span>
<span class="sd">           propagation of an UPDATE from a source column to dependent columns</span>
<span class="sd">           on joined-table rows.</span>

<span class="sd">           When False, it is assumed that the database does not enforce</span>
<span class="sd">           referential integrity and will not be issuing its own CASCADE</span>
<span class="sd">           operation for an update.  The unit of work process will</span>
<span class="sd">           emit an UPDATE statement for the dependent columns during a</span>
<span class="sd">           primary key change.</span>

<span class="sd">           .. seealso::</span>

<span class="sd">               :ref:`passive_updates` - description of a similar feature as</span>
<span class="sd">               used with :func:`.relationship`</span>

<span class="sd">        :param polymorphic_on: Specifies the column, attribute, or</span>
<span class="sd">          SQL expression used to determine the target class for an</span>
<span class="sd">          incoming row, when inheriting classes are present.</span>

<span class="sd">          This value is commonly a :class:`.Column` object that&#39;s</span>
<span class="sd">          present in the mapped :class:`.Table`::</span>

<span class="sd">            class Employee(Base):</span>
<span class="sd">                __tablename__ = &#39;employee&#39;</span>

<span class="sd">                id = Column(Integer, primary_key=True)</span>
<span class="sd">                discriminator = Column(String(50))</span>

<span class="sd">                __mapper_args__ = {</span>
<span class="sd">                    &quot;polymorphic_on&quot;:discriminator,</span>
<span class="sd">                    &quot;polymorphic_identity&quot;:&quot;employee&quot;</span>
<span class="sd">                }</span>

<span class="sd">          It may also be specified</span>
<span class="sd">          as a SQL expression, as in this example where we</span>
<span class="sd">          use the :func:`.case` construct to provide a conditional</span>
<span class="sd">          approach::</span>

<span class="sd">            class Employee(Base):</span>
<span class="sd">                __tablename__ = &#39;employee&#39;</span>

<span class="sd">                id = Column(Integer, primary_key=True)</span>
<span class="sd">                discriminator = Column(String(50))</span>

<span class="sd">                __mapper_args__ = {</span>
<span class="sd">                    &quot;polymorphic_on&quot;:case([</span>
<span class="sd">                        (discriminator == &quot;EN&quot;, &quot;engineer&quot;),</span>
<span class="sd">                        (discriminator == &quot;MA&quot;, &quot;manager&quot;),</span>
<span class="sd">                    ], else_=&quot;employee&quot;),</span>
<span class="sd">                    &quot;polymorphic_identity&quot;:&quot;employee&quot;</span>
<span class="sd">                }</span>

<span class="sd">          It may also refer to any attribute</span>
<span class="sd">          configured with :func:`.column_property`, or to the</span>
<span class="sd">          string name of one::</span>

<span class="sd">                class Employee(Base):</span>
<span class="sd">                    __tablename__ = &#39;employee&#39;</span>

<span class="sd">                    id = Column(Integer, primary_key=True)</span>
<span class="sd">                    discriminator = Column(String(50))</span>
<span class="sd">                    employee_type = column_property(</span>
<span class="sd">                        case([</span>
<span class="sd">                            (discriminator == &quot;EN&quot;, &quot;engineer&quot;),</span>
<span class="sd">                            (discriminator == &quot;MA&quot;, &quot;manager&quot;),</span>
<span class="sd">                        ], else_=&quot;employee&quot;)</span>
<span class="sd">                    )</span>

<span class="sd">                    __mapper_args__ = {</span>
<span class="sd">                        &quot;polymorphic_on&quot;:employee_type,</span>
<span class="sd">                        &quot;polymorphic_identity&quot;:&quot;employee&quot;</span>
<span class="sd">                    }</span>

<span class="sd">          .. versionchanged:: 0.7.4</span>
<span class="sd">              ``polymorphic_on`` may be specified as a SQL expression,</span>
<span class="sd">              or refer to any attribute configured with</span>
<span class="sd">              :func:`.column_property`, or to the string name of one.</span>

<span class="sd">          When setting ``polymorphic_on`` to reference an</span>
<span class="sd">          attribute or expression that&#39;s not present in the</span>
<span class="sd">          locally mapped :class:`.Table`, yet the value</span>
<span class="sd">          of the discriminator should be persisted to the database,</span>
<span class="sd">          the value of the</span>
<span class="sd">          discriminator is not automatically set on new</span>
<span class="sd">          instances; this must be handled by the user,</span>
<span class="sd">          either through manual means or via event listeners.</span>
<span class="sd">          A typical approach to establishing such a listener</span>
<span class="sd">          looks like::</span>

<span class="sd">                from sqlalchemy import event</span>
<span class="sd">                from sqlalchemy.orm import object_mapper</span>

<span class="sd">                @event.listens_for(Employee, &quot;init&quot;, propagate=True)</span>
<span class="sd">                def set_identity(instance, *arg, **kw):</span>
<span class="sd">                    mapper = object_mapper(instance)</span>
<span class="sd">                    instance.discriminator = mapper.polymorphic_identity</span>

<span class="sd">          Where above, we assign the value of ``polymorphic_identity``</span>
<span class="sd">          for the mapped class to the ``discriminator`` attribute,</span>
<span class="sd">          thus persisting the value to the ``discriminator`` column</span>
<span class="sd">          in the database.</span>

<span class="sd">          .. warning::</span>

<span class="sd">             Currently, **only one discriminator column may be set**, typically</span>
<span class="sd">             on the base-most class in the hierarchy. &quot;Cascading&quot; polymorphic</span>
<span class="sd">             columns are not yet supported.</span>

<span class="sd">          .. seealso::</span>

<span class="sd">            :ref:`inheritance_toplevel`</span>

<span class="sd">        :param polymorphic_identity: Specifies the value which</span>
<span class="sd">          identifies this particular class as returned by the</span>
<span class="sd">          column expression referred to by the ``polymorphic_on``</span>
<span class="sd">          setting.  As rows are received, the value corresponding</span>
<span class="sd">          to the ``polymorphic_on`` column expression is compared</span>
<span class="sd">          to this value, indicating which subclass should</span>
<span class="sd">          be used for the newly reconstructed object.</span>

<span class="sd">        :param properties: A dictionary mapping the string names of object</span>
<span class="sd">           attributes to :class:`.MapperProperty` instances, which define the</span>
<span class="sd">           persistence behavior of that attribute.  Note that :class:`.Column`</span>
<span class="sd">           objects present in</span>
<span class="sd">           the mapped :class:`.Table` are automatically placed into</span>
<span class="sd">           ``ColumnProperty`` instances upon mapping, unless overridden.</span>
<span class="sd">           When using Declarative, this argument is passed automatically,</span>
<span class="sd">           based on all those :class:`.MapperProperty` instances declared</span>
<span class="sd">           in the declared class body.</span>

<span class="sd">        :param primary_key: A list of :class:`.Column` objects which define</span>
<span class="sd">           the primary key to be used against this mapper&#39;s selectable unit.</span>
<span class="sd">           This is normally simply the primary key of the ``local_table``, but</span>
<span class="sd">           can be overridden here.</span>

<span class="sd">        :param version_id_col: A :class:`.Column`</span>
<span class="sd">           that will be used to keep a running version id of rows</span>
<span class="sd">           in the table.  This is used to detect concurrent updates or</span>
<span class="sd">           the presence of stale data in a flush.  The methodology is to</span>
<span class="sd">           detect if an UPDATE statement does not match the last known</span>
<span class="sd">           version id, a</span>
<span class="sd">           :class:`~sqlalchemy.orm.exc.StaleDataError` exception is</span>
<span class="sd">           thrown.</span>
<span class="sd">           By default, the column must be of :class:`.Integer` type,</span>
<span class="sd">           unless ``version_id_generator`` specifies an alternative version</span>
<span class="sd">           generator.</span>

<span class="sd">           .. seealso::</span>

<span class="sd">              :ref:`mapper_version_counter` - discussion of version counting</span>
<span class="sd">              and rationale.</span>

<span class="sd">        :param version_id_generator: Define how new version ids should</span>
<span class="sd">          be generated.  Defaults to ``None``, which indicates that</span>
<span class="sd">          a simple integer counting scheme be employed.  To provide a custom</span>
<span class="sd">          versioning scheme, provide a callable function of the form::</span>

<span class="sd">              def generate_version(version):</span>
<span class="sd">                  return next_version</span>

<span class="sd">          Alternatively, server-side versioning functions such as triggers,</span>
<span class="sd">          or programmatic versioning schemes outside of the version id</span>
<span class="sd">          generator may be used, by specifying the value ``False``.</span>
<span class="sd">          Please see :ref:`server_side_version_counter` for a discussion</span>
<span class="sd">          of important points when using this option.</span>

<span class="sd">          .. versionadded:: 0.9.0 ``version_id_generator`` supports</span>
<span class="sd">             server-side version number generation.</span>

<span class="sd">          .. seealso::</span>

<span class="sd">             :ref:`custom_version_counter`</span>

<span class="sd">             :ref:`server_side_version_counter`</span>


<span class="sd">        :param with_polymorphic: A tuple in the form ``(&lt;classes&gt;,</span>
<span class="sd">            &lt;selectable&gt;)`` indicating the default style of &quot;polymorphic&quot;</span>
<span class="sd">            loading, that is, which tables are queried at once. &lt;classes&gt; is</span>
<span class="sd">            any single or list of mappers and/or classes indicating the</span>
<span class="sd">            inherited classes that should be loaded at once. The special value</span>
<span class="sd">            ``&#39;*&#39;`` may be used to indicate all descending classes should be</span>
<span class="sd">            loaded immediately. The second tuple argument &lt;selectable&gt;</span>
<span class="sd">            indicates a selectable that will be used to query for multiple</span>
<span class="sd">            classes.</span>

<span class="sd">            .. seealso::</span>

<span class="sd">              :ref:`with_polymorphic` - discussion of polymorphic querying</span>
<span class="sd">              techniques.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">class_</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">assert_arg_type</span><span class="p">(</span><span class="n">class_</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="s">&#39;class_&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">class_manager</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_primary_key_argument</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="n">primary_key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">non_primary</span> <span class="o">=</span> <span class="n">non_primary</span>

        <span class="k">if</span> <span class="n">order_by</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">order_by</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="n">order_by</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">order_by</span> <span class="o">=</span> <span class="n">order_by</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">always_refresh</span> <span class="o">=</span> <span class="n">always_refresh</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">version_id_col</span><span class="p">,</span> <span class="n">MapperProperty</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">version_id_prop</span> <span class="o">=</span> <span class="n">version_id_col</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">version_id_col</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">version_id_col</span> <span class="o">=</span> <span class="n">version_id_col</span>
        <span class="k">if</span> <span class="n">version_id_generator</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">version_id_generator</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">elif</span> <span class="n">version_id_generator</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">version_id_generator</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">version_id_generator</span> <span class="o">=</span> <span class="n">version_id_generator</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">concrete</span> <span class="o">=</span> <span class="n">concrete</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">single</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span> <span class="o">=</span> <span class="n">inherits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_table</span> <span class="o">=</span> <span class="n">local_table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inherit_condition</span> <span class="o">=</span> <span class="n">inherit_condition</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inherit_foreign_keys</span> <span class="o">=</span> <span class="n">inherit_foreign_keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_properties</span> <span class="o">=</span> <span class="n">properties</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_delete_orphans</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch</span> <span class="o">=</span> <span class="n">batch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eager_defaults</span> <span class="o">=</span> <span class="n">eager_defaults</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column_prefix</span> <span class="o">=</span> <span class="n">column_prefix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_on</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">_clause_element_as_expr</span><span class="p">(</span>
            <span class="n">polymorphic_on</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependency_processors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validators</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">immutabledict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">passive_updates</span> <span class="o">=</span> <span class="n">passive_updates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">legacy_is_orphan</span> <span class="o">=</span> <span class="n">legacy_is_orphan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clause_adapter</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_requires_row_aliasing</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inherits_equated_pairs</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_memoized_values</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compiled_cache_size</span> <span class="o">=</span> <span class="n">_compiled_cache_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reconstructor</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_deprecated_extensions</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="n">extension</span> <span class="ow">or</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allow_partial_pks</span> <span class="o">=</span> <span class="n">allow_partial_pks</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">concrete</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">confirm_deleted_rows</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">confirm_deleted_rows</span> <span class="o">=</span> <span class="n">confirm_deleted_rows</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_with_polymorphic</span><span class="p">(</span><span class="n">with_polymorphic</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_table</span><span class="p">,</span> <span class="n">expression</span><span class="o">.</span><span class="n">SelectBase</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
                <span class="s">&quot;When mapping against a select() construct, map against &quot;</span>
                <span class="s">&quot;an alias() of the construct instead.&quot;</span>
                <span class="s">&quot;This because several databases don&#39;t allow a &quot;</span>
                <span class="s">&quot;SELECT from a subquery that does not have an alias.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_polymorphic</span> <span class="ow">and</span> \
            <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">with_polymorphic</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                       <span class="n">expression</span><span class="o">.</span><span class="n">SelectBase</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">with_polymorphic</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">with_polymorphic</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">with_polymorphic</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">alias</span><span class="p">())</span>

        <span class="c"># our &#39;polymorphic identity&#39;, a string name that when located in a</span>
        <span class="c">#  result set row indicates this Mapper should be used to construct</span>
        <span class="c"># the object instance for that row.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_identity</span> <span class="o">=</span> <span class="n">polymorphic_identity</span>

        <span class="c"># a dictionary of &#39;polymorphic identity&#39; names, associating those</span>
        <span class="c"># names with Mappers that will be used to construct object instances</span>
        <span class="c"># upon a select operation.</span>
        <span class="k">if</span> <span class="n">_polymorphic_map</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_map</span> <span class="o">=</span> <span class="n">_polymorphic_map</span>

        <span class="k">if</span> <span class="n">include_properties</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">include_properties</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">to_set</span><span class="p">(</span><span class="n">include_properties</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">include_properties</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">exclude_properties</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exclude_properties</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">to_set</span><span class="p">(</span><span class="n">exclude_properties</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exclude_properties</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">configured</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c"># prevent this mapper from being constructed</span>
        <span class="c"># while a configure_mappers() is occurring (and defer a</span>
        <span class="c"># configure_mappers() until construction succeeds)</span>
        <span class="n">_CONFIGURE_MUTEX</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">_events</span><span class="o">.</span><span class="n">_new_mapper_instance</span><span class="p">(</span><span class="n">class_</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_configure_inheritance</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_configure_legacy_instrument_class</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_configure_class_instrumentation</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_configure_listeners</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_configure_properties</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_configure_polymorphic_setter</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_configure_pks</span><span class="p">()</span>
            <span class="n">Mapper</span><span class="o">.</span><span class="n">_new_mappers</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;constructed&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expire_memoizations</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">_CONFIGURE_MUTEX</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

    <span class="c"># major attributes initialized at the classlevel so that</span>
    <span class="c"># they can be Sphinx-documented.</span>

    <span class="n">is_mapper</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="sd">&quot;&quot;&quot;Part of the inspection API.&quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mapper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Part of the inspection API.</span>

<span class="sd">        Returns self.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">entity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Part of the inspection API.</span>

<span class="sd">        Returns self.class\_.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_</span>

    <span class="n">local_table</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;The :class:`.Selectable` which this :class:`.Mapper` manages.</span>

<span class="sd">    Typically is an instance of :class:`.Table` or :class:`.Alias`.</span>
<span class="sd">    May also be ``None``.</span>

<span class="sd">    The &quot;local&quot; table is the</span>
<span class="sd">    selectable that the :class:`.Mapper` is directly responsible for</span>
<span class="sd">    managing from an attribute access and flush perspective.   For</span>
<span class="sd">    non-inheriting mappers, the local table is the same as the</span>
<span class="sd">    &quot;mapped&quot; table.   For joined-table inheritance mappers, local_table</span>
<span class="sd">    will be the particular sub-table of the overall &quot;join&quot; which</span>
<span class="sd">    this :class:`.Mapper` represents.  If this mapper is a</span>
<span class="sd">    single-table inheriting mapper, local_table will be ``None``.</span>

<span class="sd">    .. seealso::</span>

<span class="sd">        :attr:`~.Mapper.mapped_table`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">mapped_table</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;The :class:`.Selectable` to which this :class:`.Mapper` is mapped.</span>

<span class="sd">    Typically an instance of :class:`.Table`, :class:`.Join`, or</span>
<span class="sd">    :class:`.Alias`.</span>

<span class="sd">    The &quot;mapped&quot; table is the selectable that</span>
<span class="sd">    the mapper selects from during queries.   For non-inheriting</span>
<span class="sd">    mappers, the mapped table is the same as the &quot;local&quot; table.</span>
<span class="sd">    For joined-table inheritance mappers, mapped_table references the</span>
<span class="sd">    full :class:`.Join` representing full rows for this particular</span>
<span class="sd">    subclass.  For single-table inheritance mappers, mapped_table</span>
<span class="sd">    references the base table.</span>

<span class="sd">    .. seealso::</span>

<span class="sd">        :attr:`~.Mapper.local_table`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">inherits</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;References the :class:`.Mapper` which this :class:`.Mapper`</span>
<span class="sd">    inherits from, if any.</span>

<span class="sd">    This is a *read only* attribute determined during mapper construction.</span>
<span class="sd">    Behavior is undefined if directly modified.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">configured</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;Represent ``True`` if this :class:`.Mapper` has been configured.</span>

<span class="sd">    This is a *read only* attribute determined during mapper construction.</span>
<span class="sd">    Behavior is undefined if directly modified.</span>

<span class="sd">    .. seealso::</span>

<span class="sd">        :func:`.configure_mappers`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">concrete</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;Represent ``True`` if this :class:`.Mapper` is a concrete</span>
<span class="sd">    inheritance mapper.</span>

<span class="sd">    This is a *read only* attribute determined during mapper construction.</span>
<span class="sd">    Behavior is undefined if directly modified.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">tables</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;An iterable containing the collection of :class:`.Table` objects</span>
<span class="sd">    which this :class:`.Mapper` is aware of.</span>

<span class="sd">    If the mapper is mapped to a :class:`.Join`, or an :class:`.Alias`</span>
<span class="sd">    representing a :class:`.Select`, the individual :class:`.Table`</span>
<span class="sd">    objects that comprise the full construct will be represented here.</span>

<span class="sd">    This is a *read only* attribute determined during mapper construction.</span>
<span class="sd">    Behavior is undefined if directly modified.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">primary_key</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;An iterable containing the collection of :class:`.Column` objects</span>
<span class="sd">    which comprise the &#39;primary key&#39; of the mapped table, from the</span>
<span class="sd">    perspective of this :class:`.Mapper`.</span>

<span class="sd">    This list is against the selectable in :attr:`~.Mapper.mapped_table`. In</span>
<span class="sd">    the case of inheriting mappers, some columns may be managed by a</span>
<span class="sd">    superclass mapper.  For example, in the case of a :class:`.Join`, the</span>
<span class="sd">    primary key is determined by all of the primary key columns across all</span>
<span class="sd">    tables referenced by the :class:`.Join`.</span>

<span class="sd">    The list is also not necessarily the same as the primary key column</span>
<span class="sd">    collection associated with the underlying tables; the :class:`.Mapper`</span>
<span class="sd">    features a ``primary_key`` argument that can override what the</span>
<span class="sd">    :class:`.Mapper` considers as primary key columns.</span>

<span class="sd">    This is a *read only* attribute determined during mapper construction.</span>
<span class="sd">    Behavior is undefined if directly modified.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">class_</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;The Python class which this :class:`.Mapper` maps.</span>

<span class="sd">    This is a *read only* attribute determined during mapper construction.</span>
<span class="sd">    Behavior is undefined if directly modified.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">class_manager</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;The :class:`.ClassManager` which maintains event listeners</span>
<span class="sd">    and class-bound descriptors for this :class:`.Mapper`.</span>

<span class="sd">    This is a *read only* attribute determined during mapper construction.</span>
<span class="sd">    Behavior is undefined if directly modified.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">single</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;Represent ``True`` if this :class:`.Mapper` is a single table</span>
<span class="sd">    inheritance mapper.</span>

<span class="sd">    :attr:`~.Mapper.local_table` will be ``None`` if this flag is set.</span>

<span class="sd">    This is a *read only* attribute determined during mapper construction.</span>
<span class="sd">    Behavior is undefined if directly modified.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">non_primary</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;Represent ``True`` if this :class:`.Mapper` is a &quot;non-primary&quot;</span>
<span class="sd">    mapper, e.g. a mapper that is used only to selet rows but not for</span>
<span class="sd">    persistence management.</span>

<span class="sd">    This is a *read only* attribute determined during mapper construction.</span>
<span class="sd">    Behavior is undefined if directly modified.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">polymorphic_on</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;The :class:`.Column` or SQL expression specified as the</span>
<span class="sd">    ``polymorphic_on`` argument</span>
<span class="sd">    for this :class:`.Mapper`, within an inheritance scenario.</span>

<span class="sd">    This attribute is normally a :class:`.Column` instance but</span>
<span class="sd">    may also be an expression, such as one derived from</span>
<span class="sd">    :func:`.cast`.</span>

<span class="sd">    This is a *read only* attribute determined during mapper construction.</span>
<span class="sd">    Behavior is undefined if directly modified.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">polymorphic_map</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;A mapping of &quot;polymorphic identity&quot; identifiers mapped to</span>
<span class="sd">    :class:`.Mapper` instances, within an inheritance scenario.</span>

<span class="sd">    The identifiers can be of any type which is comparable to the</span>
<span class="sd">    type of column represented by :attr:`~.Mapper.polymorphic_on`.</span>

<span class="sd">    An inheritance chain of mappers will all reference the same</span>
<span class="sd">    polymorphic map object.  The object is used to correlate incoming</span>
<span class="sd">    result rows to target mappers.</span>

<span class="sd">    This is a *read only* attribute determined during mapper construction.</span>
<span class="sd">    Behavior is undefined if directly modified.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">polymorphic_identity</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;Represent an identifier which is matched against the</span>
<span class="sd">    :attr:`~.Mapper.polymorphic_on` column during result row loading.</span>

<span class="sd">    Used only with inheritance, this object can be of any type which is</span>
<span class="sd">    comparable to the type of column represented by</span>
<span class="sd">    :attr:`~.Mapper.polymorphic_on`.</span>

<span class="sd">    This is a *read only* attribute determined during mapper construction.</span>
<span class="sd">    Behavior is undefined if directly modified.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">base_mapper</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;The base-most :class:`.Mapper` in an inheritance chain.</span>

<span class="sd">    In a non-inheriting scenario, this attribute will always be this</span>
<span class="sd">    :class:`.Mapper`.   In an inheritance scenario, it references</span>
<span class="sd">    the :class:`.Mapper` which is parent to all other :class:`.Mapper`</span>
<span class="sd">    objects in the inheritance chain.</span>

<span class="sd">    This is a *read only* attribute determined during mapper construction.</span>
<span class="sd">    Behavior is undefined if directly modified.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">columns</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;A collection of :class:`.Column` or other scalar expression</span>
<span class="sd">    objects maintained by this :class:`.Mapper`.</span>

<span class="sd">    The collection behaves the same as that of the ``c`` attribute on</span>
<span class="sd">    any :class:`.Table` object, except that only those columns included in</span>
<span class="sd">    this mapping are present, and are keyed based on the attribute name</span>
<span class="sd">    defined in the mapping, not necessarily the ``key`` attribute of the</span>
<span class="sd">    :class:`.Column` itself.   Additionally, scalar expressions mapped</span>
<span class="sd">    by :func:`.column_property` are also present here.</span>

<span class="sd">    This is a *read only* attribute determined during mapper construction.</span>
<span class="sd">    Behavior is undefined if directly modified.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">validators</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;An immutable dictionary of attributes which have been decorated</span>
<span class="sd">    using the :func:`~.orm.validates` decorator.</span>

<span class="sd">    The dictionary contains string attribute names as keys</span>
<span class="sd">    mapped to the actual validation method.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">c</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;A synonym for :attr:`~.Mapper.columns`.&quot;&quot;&quot;</span>

    <span class="nd">@util.memoized_property</span>
    <span class="k">def</span> <span class="nf">_path_registry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">PathRegistry</span><span class="o">.</span><span class="n">per_mapper</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_configure_inheritance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Configure settings related to inherting and/or inherited mappers</span>
<span class="sd">        being present.&quot;&quot;&quot;</span>

        <span class="c"># a set of all mappers which inherit from this one.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inheriting_mappers</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">WeakSequence</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span> <span class="o">=</span> <span class="n">class_mapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="p">,</span> <span class="n">configure</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="o">.</span><span class="n">class_</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                    <span class="s">&quot;Class &#39;</span><span class="si">%s</span><span class="s">&#39; does not inherit from &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="o">.</span><span class="n">class_</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_primary</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="o">.</span><span class="n">non_primary</span><span class="p">:</span>
                <span class="n">np</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_primary</span> <span class="ow">and</span> <span class="s">&quot;primary&quot;</span> <span class="ow">or</span> <span class="s">&quot;non-primary&quot;</span>
                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                    <span class="s">&quot;Inheritance of </span><span class="si">%s</span><span class="s"> mapper for class &#39;</span><span class="si">%s</span><span class="s">&#39; is &quot;</span>
                    <span class="s">&quot;only allowed from a </span><span class="si">%s</span><span class="s"> mapper&quot;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">np</span><span class="p">))</span>
            <span class="c"># inherit_condition is optional.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_table</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">local_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="o">.</span><span class="n">local_table</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mapped_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="o">.</span><span class="n">mapped_table</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">single</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="o">.</span><span class="n">local_table</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">concrete</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mapped_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_table</span>
                    <span class="k">for</span> <span class="n">mapper</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterate_to_root</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">mapper</span><span class="o">.</span><span class="n">polymorphic_on</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="n">mapper</span><span class="o">.</span><span class="n">_requires_row_aliasing</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherit_condition</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="c"># figure out inherit condition from our table to the</span>
                        <span class="c"># immediate table of the inherited mapper, not its</span>
                        <span class="c"># full table which could pull in other stuff we don&#39;t</span>
                        <span class="c"># want (allows test/inheritance.InheritTest4 to pass)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">inherit_condition</span> <span class="o">=</span> <span class="n">sql_util</span><span class="o">.</span><span class="n">join_condition</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="o">.</span><span class="n">local_table</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">local_table</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mapped_table</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="o">.</span><span class="n">mapped_table</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">local_table</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">inherit_condition</span><span class="p">)</span>

                    <span class="n">fks</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">to_set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inherit_foreign_keys</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_inherits_equated_pairs</span> <span class="o">=</span> \
                        <span class="n">sql_util</span><span class="o">.</span><span class="n">criterion_as_pairs</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">mapped_table</span><span class="o">.</span><span class="n">onclause</span><span class="p">,</span>
                            <span class="n">consider_as_foreign_keys</span><span class="o">=</span><span class="n">fks</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mapped_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_table</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_identity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">concrete</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_identity_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="o">.</span><span class="n">_identity_class</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_identity_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_id_col</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">version_id_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="o">.</span><span class="n">version_id_col</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">version_id_generator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="o">.</span><span class="n">version_id_generator</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="o">.</span><span class="n">version_id_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">version_id_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="o">.</span><span class="n">version_id_col</span><span class="p">:</span>
                <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s">&quot;Inheriting version_id_col &#39;</span><span class="si">%s</span><span class="s">&#39; does not match inherited &quot;</span>
                    <span class="s">&quot;version_id_col &#39;</span><span class="si">%s</span><span class="s">&#39; and will not automatically populate &quot;</span>
                    <span class="s">&quot;the inherited versioning column. &quot;</span>
                    <span class="s">&quot;version_id_col should only be specified on &quot;</span>
                    <span class="s">&quot;the base-most mapper that includes versioning.&quot;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version_id_col</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="o">.</span><span class="n">version_id_col</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_by</span> <span class="ow">is</span> <span class="bp">False</span> <span class="ow">and</span> \
                    <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">concrete</span> <span class="ow">and</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="o">.</span><span class="n">order_by</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">False</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">order_by</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="o">.</span><span class="n">order_by</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="o">.</span><span class="n">polymorphic_map</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="o">.</span><span class="n">batch</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="o">.</span><span class="n">_inheriting_mappers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_mapper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="o">.</span><span class="n">base_mapper</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">passive_updates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="o">.</span><span class="n">passive_updates</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_all_tables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="o">.</span><span class="n">_all_tables</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_identity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_identity</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_map</span><span class="p">:</span>
                    <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="s">&quot;Reassigning polymorphic association for identity </span><span class="si">%r</span><span class="s"> &quot;</span>
                        <span class="s">&quot;from </span><span class="si">%r</span><span class="s"> to </span><span class="si">%r</span><span class="s">: Check for duplicate use of </span><span class="si">%r</span><span class="s"> as &quot;</span>
                        <span class="s">&quot;value for polymorphic_identity.&quot;</span> <span class="o">%</span>
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_identity</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_identity</span><span class="p">],</span>
                         <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_identity</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_identity</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_all_tables</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_mapper</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mapped_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_table</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_identity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_identity</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_identity_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapped_table</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                <span class="s">&quot;Mapper &#39;</span><span class="si">%s</span><span class="s">&#39; does not have a mapped_table specified.&quot;</span>
                <span class="o">%</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_with_polymorphic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_polymorphic</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">with_polymorphic</span> <span class="o">==</span> <span class="s">&#39;*&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">with_polymorphic</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;*&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">with_polymorphic</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
                    <span class="n">with_polymorphic</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">util</span><span class="o">.</span><span class="n">string_types</span> <span class="o">+</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">with_polymorphic</span> <span class="o">=</span> <span class="n">with_polymorphic</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">with_polymorphic</span> <span class="o">=</span> <span class="p">(</span><span class="n">with_polymorphic</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">with_polymorphic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span><span class="s">&quot;Invalid setting for with_polymorphic&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">with_polymorphic</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_table</span><span class="p">,</span> <span class="n">expression</span><span class="o">.</span><span class="n">SelectBase</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
                <span class="s">&quot;When mapping against a select() construct, map against &quot;</span>
                <span class="s">&quot;an alias() of the construct instead.&quot;</span>
                <span class="s">&quot;This because several databases don&#39;t allow a &quot;</span>
                <span class="s">&quot;SELECT from a subquery that does not have an alias.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_polymorphic</span> <span class="ow">and</span> \
            <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">with_polymorphic</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                       <span class="n">expression</span><span class="o">.</span><span class="n">SelectBase</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">with_polymorphic</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">with_polymorphic</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">with_polymorphic</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">alias</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">configured</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expire_memoizations</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_set_concrete_base</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapper</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the given :class:`.Mapper` as the &#39;inherits&#39; for this</span>
<span class="sd">        :class:`.Mapper`, assuming this :class:`.Mapper` is concrete</span>
<span class="sd">        and does not already have an inherits.&quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">concrete</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mapper</span><span class="p">,</span> <span class="n">Mapper</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span> <span class="o">=</span> <span class="n">mapper</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="o">.</span><span class="n">polymorphic_map</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_map</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="o">.</span><span class="n">polymorphic_map</span>
        <span class="k">for</span> <span class="n">mapper</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterate_to_root</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">mapper</span><span class="o">.</span><span class="n">polymorphic_on</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">mapper</span><span class="o">.</span><span class="n">_requires_row_aliasing</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="o">.</span><span class="n">batch</span>
        <span class="k">for</span> <span class="n">mp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">self_and_descendants</span><span class="p">:</span>
            <span class="n">mp</span><span class="o">.</span><span class="n">base_mapper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="o">.</span><span class="n">base_mapper</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="o">.</span><span class="n">_inheriting_mappers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">passive_updates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="o">.</span><span class="n">passive_updates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_all_tables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="o">.</span><span class="n">_all_tables</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">mapper</span><span class="o">.</span><span class="n">_props</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span> <span class="ow">and</span> \
                <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_exclude</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">local</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                         <span class="n">column</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_adapt_inherited_property</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_polymorphic_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">polymorphic_on</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_on</span> <span class="o">=</span> <span class="n">polymorphic_on</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configure_polymorphic_setter</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_configure_legacy_instrument_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">_update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="o">.</span><span class="n">dispatch</span><span class="p">)</span>
            <span class="n">super_extensions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                <span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">_deprecated_extensions</span>
                        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="o">.</span><span class="n">iterate_to_root</span><span class="p">()]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">super_extensions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deprecated_extensions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ext</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">super_extensions</span><span class="p">:</span>
                <span class="n">ext</span><span class="o">.</span><span class="n">_adapt_instrument_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_configure_listeners</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="p">:</span>
            <span class="n">super_extensions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                <span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">_deprecated_extensions</span>
                        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="o">.</span><span class="n">iterate_to_root</span><span class="p">()]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">super_extensions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deprecated_extensions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ext</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">super_extensions</span><span class="p">:</span>
                <span class="n">ext</span><span class="o">.</span><span class="n">_adapt_listener</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_configure_class_instrumentation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;If this mapper is to be a primary mapper (i.e. the</span>
<span class="sd">        non_primary flag is not set), associate this Mapper with the</span>
<span class="sd">        given class_ and entity name.</span>

<span class="sd">        Subsequent calls to ``class_mapper()`` for the class_/entity</span>
<span class="sd">        name combination will return this mapper.  Also decorate the</span>
<span class="sd">        `__init__` method on the mapped class to include optional</span>
<span class="sd">        auto-session attachment logic.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">manager</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">manager_of_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_primary</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">manager</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">manager</span><span class="o">.</span><span class="n">is_mapped</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
                    <span class="s">&quot;Class </span><span class="si">%s</span><span class="s"> has no primary mapper configured.  Configure &quot;</span>
                    <span class="s">&quot;a primary mapper first before setting up a non primary &quot;</span>
                    <span class="s">&quot;Mapper.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">class_manager</span> <span class="o">=</span> <span class="n">manager</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_identity_class</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">_identity_class</span>
            <span class="n">_mapper_registry</span><span class="p">[</span><span class="bp">self</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">manager</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">manager</span><span class="o">.</span><span class="n">class_</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_</span>
            <span class="k">if</span> <span class="n">manager</span><span class="o">.</span><span class="n">is_mapped</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                    <span class="s">&quot;Class &#39;</span><span class="si">%s</span><span class="s">&#39; already has a primary mapper defined. &quot;</span>
                    <span class="s">&quot;Use non_primary=True to &quot;</span>
                    <span class="s">&quot;create a non primary Mapper.  clear_mappers() will &quot;</span>
                    <span class="s">&quot;remove *all* current mappers from all classes.&quot;</span> <span class="o">%</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">class_</span><span class="p">)</span>
            <span class="c"># else:</span>
                <span class="c"># a ClassManager may already exist as</span>
                <span class="c"># ClassManager.instrument_attribute() creates</span>
                <span class="c"># new managers for each subclass if they don&#39;t yet exist.</span>

        <span class="n">_mapper_registry</span><span class="p">[</span><span class="bp">self</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c"># note: this *must be called before instrumentation.register_class*</span>
        <span class="c"># to maintain the documented behavior of instrument_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">instrument_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">manager</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">manager</span> <span class="o">=</span> <span class="n">instrumentation</span><span class="o">.</span><span class="n">register_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">class_manager</span> <span class="o">=</span> <span class="n">manager</span>

        <span class="n">manager</span><span class="o">.</span><span class="n">mapper</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">manager</span><span class="o">.</span><span class="n">deferred_scalar_loader</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
            <span class="n">loading</span><span class="o">.</span><span class="n">load_scalar_attributes</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="c"># The remaining members can be added by any mapper,</span>
        <span class="c"># e_name None or not.</span>
        <span class="k">if</span> <span class="n">manager</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_INSTRUMENTOR</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="n">event</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="s">&#39;first_init&#39;</span><span class="p">,</span> <span class="n">_event_on_first_init</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="s">&#39;init&#39;</span><span class="p">,</span> <span class="n">_event_on_init</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">util</span><span class="o">.</span><span class="n">iterate_attributes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="s">&#39;__sa_reconstructor__&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_reconstructor</span> <span class="o">=</span> <span class="n">method</span>
                    <span class="n">event</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="s">&#39;load&#39;</span><span class="p">,</span> <span class="n">_event_on_load</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="s">&#39;__sa_validators__&#39;</span><span class="p">):</span>
                    <span class="n">validation_opts</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="n">__sa_validation_opts__</span>
                    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">method</span><span class="o">.</span><span class="n">__sa_validators__</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">validators</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">union</span><span class="p">(</span>
                            <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">validation_opts</span><span class="p">)}</span>
                        <span class="p">)</span>

        <span class="n">manager</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">_INSTRUMENTOR</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_configure_all</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Class-level path to the :func:`.configure_mappers` call.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">configure_mappers</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">dispose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Disable any attribute-based compilation.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configured</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_configure_failed&#39;</span><span class="p">):</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configure_failed</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_primary</span> <span class="ow">and</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">class_manager</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">class_manager</span><span class="o">.</span><span class="n">is_mapped</span> <span class="ow">and</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">class_manager</span><span class="o">.</span><span class="n">mapper</span> <span class="ow">is</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">instrumentation</span><span class="o">.</span><span class="n">unregister_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_configure_pks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tables</span> <span class="o">=</span> <span class="n">sql_util</span><span class="o">.</span><span class="n">find_tables</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mapped_table</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pks_by_table</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cols_by_table</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">all_cols</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">column_set</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="p">[</span>
            <span class="n">col</span><span class="o">.</span><span class="n">proxy_set</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_columntoproperty</span><span class="p">]))</span>

        <span class="n">pk_cols</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">column_set</span><span class="p">(</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">all_cols</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">primary_key</span><span class="p">)</span>

        <span class="c"># identify primary key columns which are also mapped by this mapper.</span>
        <span class="n">tables</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tables</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mapped_table</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_all_tables</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tables</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">primary_key</span> <span class="ow">and</span> <span class="n">pk_cols</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">primary_key</span><span class="p">):</span>
                <span class="c"># ordering is important since it determines the ordering of</span>
                <span class="c"># mapper.primary_key (and therefore query.get())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pks_by_table</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">util</span><span class="o">.</span><span class="n">ordered_column_set</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">primary_key</span><span class="p">)</span><span class="o">.</span>\
                    <span class="n">intersection</span><span class="p">(</span><span class="n">pk_cols</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cols_by_table</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">util</span><span class="o">.</span><span class="n">ordered_column_set</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">c</span><span class="p">)</span><span class="o">.</span>\
                <span class="n">intersection</span><span class="p">(</span><span class="n">all_cols</span><span class="p">)</span>

        <span class="c"># if explicit PK argument sent, add those columns to the</span>
        <span class="c"># primary key mappings</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_primary_key_argument</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_primary_key_argument</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">table</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pks_by_table</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_pks_by_table</span><span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">table</span><span class="p">]</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">OrderedSet</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pks_by_table</span><span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">table</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

        <span class="c"># otherwise, see that we got a full PK for the mapped table</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapped_table</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pks_by_table</span> <span class="ow">or</span> \
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pks_by_table</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mapped_table</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                <span class="s">&quot;Mapper </span><span class="si">%s</span><span class="s"> could not assemble any primary &quot;</span>
                <span class="s">&quot;key columns for mapped table &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span>
                <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapped_table</span><span class="o">.</span><span class="n">description</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_table</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pks_by_table</span> <span class="ow">and</span> \
                <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_table</span><span class="p">,</span> <span class="n">schema</span><span class="o">.</span><span class="n">Table</span><span class="p">):</span>
            <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Could not assemble any primary &quot;</span>
                      <span class="s">&quot;keys for locally mapped table &#39;</span><span class="si">%s</span><span class="s">&#39; - &quot;</span>
                      <span class="s">&quot;no rows will be persisted in this Table.&quot;</span>
                      <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_table</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span> <span class="ow">and</span> \
                <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">concrete</span> <span class="ow">and</span> \
                <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_primary_key_argument</span><span class="p">:</span>
            <span class="c"># if inheriting, the &quot;primary key&quot; for this mapper is</span>
            <span class="c"># that of the inheriting (unless concrete or explicit)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="o">.</span><span class="n">primary_key</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># determine primary key from argument or mapped_table pks -</span>
            <span class="c"># reduce to the minimal set of columns</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_primary_key_argument</span><span class="p">:</span>
                <span class="n">primary_key</span> <span class="o">=</span> <span class="n">sql_util</span><span class="o">.</span><span class="n">reduce_columns</span><span class="p">(</span>
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mapped_table</span><span class="o">.</span><span class="n">corresponding_column</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">_primary_key_argument</span><span class="p">],</span>
                    <span class="n">ignore_nonexistent_tables</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">primary_key</span> <span class="o">=</span> <span class="n">sql_util</span><span class="o">.</span><span class="n">reduce_columns</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_pks_by_table</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mapped_table</span><span class="p">],</span>
                    <span class="n">ignore_nonexistent_tables</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">primary_key</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                    <span class="s">&quot;Mapper </span><span class="si">%s</span><span class="s"> could not assemble any primary &quot;</span>
                    <span class="s">&quot;key columns for mapped table &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapped_table</span><span class="o">.</span><span class="n">description</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">primary_key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;Identified primary key columns: </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">primary_key</span><span class="p">)</span>

        <span class="c"># determine cols that aren&#39;t expressed within our tables; mark these</span>
        <span class="c"># as &quot;read only&quot; properties which are refreshed upon INSERT/UPDATE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_readonly_props</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_columntoproperty</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columntoproperty</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columntoproperty</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identity_key_props</span> <span class="ow">and</span>
            <span class="p">(</span><span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s">&#39;table&#39;</span><span class="p">)</span> <span class="ow">or</span>
                <span class="n">col</span><span class="o">.</span><span class="n">table</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cols_by_table</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_configure_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c"># Column and other ClauseElement objects which are mapped</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">OrderedProperties</span><span class="p">()</span>

        <span class="c"># object attribute names mapped to MapperProperty objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_props</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

        <span class="c"># table columns mapped to lists of MapperProperty objects</span>
        <span class="c"># using a list allows a single column to be defined as</span>
        <span class="c"># populating multiple object attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_columntoproperty</span> <span class="o">=</span> <span class="n">_ColumnMapping</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c"># load custom properties</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_properties</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">prop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_properties</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_configure_property</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

        <span class="c"># pull properties from the inherited mapper if any.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">prop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="o">.</span><span class="n">_props</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span> <span class="ow">and</span> \
                    <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_exclude</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">local</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                             <span class="n">column</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_adapt_inherited_property</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

        <span class="c"># create properties for each column in the mapped table,</span>
        <span class="c"># for those columns which don&#39;t already map to a property</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapped_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">column</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columntoproperty</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">column_key</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">column_prefix</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">column</span><span class="o">.</span><span class="n">key</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_exclude</span><span class="p">(</span>
                <span class="n">column</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">column_key</span><span class="p">,</span>
                <span class="n">local</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">local_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">contains_column</span><span class="p">(</span><span class="n">column</span><span class="p">),</span>
                <span class="n">column</span><span class="o">=</span><span class="n">column</span>
            <span class="p">):</span>
                <span class="k">continue</span>

            <span class="c"># adjust the &quot;key&quot; used for this column to that</span>
            <span class="c"># of the inheriting mapper</span>
            <span class="k">for</span> <span class="n">mapper</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterate_to_root</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">mapper</span><span class="o">.</span><span class="n">_columntoproperty</span><span class="p">:</span>
                    <span class="n">column_key</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="n">_columntoproperty</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">key</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_configure_property</span><span class="p">(</span><span class="n">column_key</span><span class="p">,</span>
                                     <span class="n">column</span><span class="p">,</span>
                                     <span class="n">init</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                     <span class="n">setparent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_configure_polymorphic_setter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Configure an attribute on the mapper representing the</span>
<span class="sd">        &#39;polymorphic_on&#39; column, if applicable, and not</span>
<span class="sd">        already generated by _configure_properties (which is typical).</span>

<span class="sd">        Also create a setter function which will assign this</span>
<span class="sd">        attribute to the value of the &#39;polymorphic_identity&#39;</span>
<span class="sd">        upon instance construction, also if applicable.  This</span>
<span class="sd">        routine will run when an instance is created.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">setter</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_on</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">setter</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_on</span><span class="p">,</span> <span class="n">util</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                <span class="c"># polymorphic_on specified as a string - link</span>
                <span class="c"># it to mapped ColumnProperty</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_on</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_on</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                        <span class="s">&quot;Can&#39;t determine polymorphic_on &quot;</span>
                        <span class="s">&quot;value &#39;</span><span class="si">%s</span><span class="s">&#39; - no attribute is &quot;</span>
                        <span class="s">&quot;mapped to this name.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_on</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_on</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columntoproperty</span><span class="p">:</span>
                <span class="c"># polymorphic_on is a column that is already mapped</span>
                <span class="c"># to a ColumnProperty</span>
                <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columntoproperty</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_on</span><span class="p">]</span>
                <span class="n">polymorphic_key</span> <span class="o">=</span> <span class="n">prop</span><span class="o">.</span><span class="n">key</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_on</span> <span class="o">=</span> <span class="n">prop</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">polymorphic_key</span> <span class="o">=</span> <span class="n">prop</span><span class="o">.</span><span class="n">key</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_on</span><span class="p">,</span> <span class="n">MapperProperty</span><span class="p">):</span>
                <span class="c"># polymorphic_on is directly a MapperProperty,</span>
                <span class="c"># ensure it&#39;s a ColumnProperty</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_on</span><span class="p">,</span>
                                  <span class="n">properties</span><span class="o">.</span><span class="n">ColumnProperty</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                        <span class="s">&quot;Only direct column-mapped &quot;</span>
                        <span class="s">&quot;property or SQL expression &quot;</span>
                        <span class="s">&quot;can be passed for polymorphic_on&quot;</span><span class="p">)</span>
                <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_on</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_on</span> <span class="o">=</span> <span class="n">prop</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">polymorphic_key</span> <span class="o">=</span> <span class="n">prop</span><span class="o">.</span><span class="n">key</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">expression</span><span class="o">.</span><span class="n">_is_column</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_on</span><span class="p">):</span>
                <span class="c"># polymorphic_on is not a Column and not a ColumnProperty;</span>
                <span class="c"># not supported right now.</span>
                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                    <span class="s">&quot;Only direct column-mapped &quot;</span>
                    <span class="s">&quot;property or SQL expression &quot;</span>
                    <span class="s">&quot;can be passed for polymorphic_on&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># polymorphic_on is a Column or SQL expression and</span>
                <span class="c"># doesn&#39;t appear to be mapped. this means it can be 1.</span>
                <span class="c"># only present in the with_polymorphic selectable or</span>
                <span class="c"># 2. a totally standalone SQL expression which we&#39;d</span>
                <span class="c"># hope is compatible with this mapper&#39;s mapped_table</span>
                <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapped_table</span><span class="o">.</span><span class="n">corresponding_column</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_on</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">col</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="c"># polymorphic_on doesn&#39;t derive from any</span>
                    <span class="c"># column/expression isn&#39;t present in the mapped</span>
                    <span class="c"># table. we will make a &quot;hidden&quot; ColumnProperty</span>
                    <span class="c"># for it. Just check that if it&#39;s directly a</span>
                    <span class="c"># schema.Column and we have with_polymorphic, it&#39;s</span>
                    <span class="c"># likely a user error if the schema.Column isn&#39;t</span>
                    <span class="c"># represented somehow in either mapped_table or</span>
                    <span class="c"># with_polymorphic.   Otherwise as of 0.7.4 we</span>
                    <span class="c"># just go with it and assume the user wants it</span>
                    <span class="c"># that way (i.e. a CASE statement)</span>
                    <span class="n">setter</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="n">instrument</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_on</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">schema</span><span class="o">.</span><span class="n">Column</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">with_polymorphic</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">with_polymorphic</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span>
                            <span class="n">corresponding_column</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
                            <span class="s">&quot;Could not map polymorphic_on column &quot;</span>
                            <span class="s">&quot;&#39;</span><span class="si">%s</span><span class="s">&#39; to the mapped table - polymorphic &quot;</span>
                            <span class="s">&quot;loads will not function properly&quot;</span>
                            <span class="o">%</span> <span class="n">col</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># column/expression that polymorphic_on derives from</span>
                    <span class="c"># is present in our mapped table</span>
                    <span class="c"># and is probably mapped, but polymorphic_on itself</span>
                    <span class="c"># is not.  This happens when</span>
                    <span class="c"># the polymorphic_on is only directly present in the</span>
                    <span class="c"># with_polymorphic selectable, as when use</span>
                    <span class="c"># polymorphic_union.</span>
                    <span class="c"># we&#39;ll make a separate ColumnProperty for it.</span>
                    <span class="n">instrument</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">key</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s">&#39;key&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">key</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_exclude</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">col</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
                            <span class="s">&quot;Cannot exclude or override the &quot;</span>
                            <span class="s">&quot;discriminator column </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span>
                            <span class="n">col</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_on</span> <span class="o">=</span> <span class="n">col</span> <span class="o">=</span> \
                        <span class="n">col</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s">&quot;_sa_polymorphic_on&quot;</span><span class="p">)</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">key</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_configure_property</span><span class="p">(</span>
                    <span class="n">key</span><span class="p">,</span>
                    <span class="n">properties</span><span class="o">.</span><span class="n">ColumnProperty</span><span class="p">(</span><span class="n">col</span><span class="p">,</span>
                                              <span class="n">_instrument</span><span class="o">=</span><span class="n">instrument</span><span class="p">),</span>
                    <span class="n">init</span><span class="o">=</span><span class="n">init</span><span class="p">,</span> <span class="n">setparent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">polymorphic_key</span> <span class="o">=</span> <span class="n">key</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># no polymorphic_on was set.</span>
            <span class="c"># check inheriting mappers for one.</span>
            <span class="k">for</span> <span class="n">mapper</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterate_to_root</span><span class="p">():</span>
                <span class="c"># determine if polymorphic_on of the parent</span>
                <span class="c"># should be propagated here.   If the col</span>
                <span class="c"># is present in our mapped table, or if our mapped</span>
                <span class="c"># table is the same as the parent (i.e. single table</span>
                <span class="c"># inheritance), we can use it</span>
                <span class="k">if</span> <span class="n">mapper</span><span class="o">.</span><span class="n">polymorphic_on</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapped_table</span> <span class="ow">is</span> <span class="n">mapper</span><span class="o">.</span><span class="n">mapped_table</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_on</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="n">polymorphic_on</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_on</span> <span class="o">=</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">mapped_table</span><span class="o">.</span><span class="n">corresponding_column</span><span class="p">(</span>
                                <span class="n">mapper</span><span class="o">.</span><span class="n">polymorphic_on</span><span class="p">)</span>
                    <span class="c"># we can use the parent mapper&#39;s _set_polymorphic_identity</span>
                    <span class="c"># directly; it ensures the polymorphic_identity of the</span>
                    <span class="c"># instance&#39;s mapper is used so is portable to subclasses.</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_on</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_set_polymorphic_identity</span> <span class="o">=</span> \
                            <span class="n">mapper</span><span class="o">.</span><span class="n">_set_polymorphic_identity</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_polymorphic_identity</span> <span class="o">=</span> \
                            <span class="n">mapper</span><span class="o">.</span><span class="n">_validate_polymorphic_identity</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_set_polymorphic_identity</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="k">return</span>

        <span class="k">if</span> <span class="n">setter</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">_set_polymorphic_identity</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
                <span class="n">dict_</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">dict</span>
                <span class="n">state</span><span class="o">.</span><span class="n">get_impl</span><span class="p">(</span><span class="n">polymorphic_key</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                    <span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span>
                    <span class="n">state</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">polymorphic_identity</span><span class="p">,</span>
                    <span class="bp">None</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">_validate_polymorphic_identity</span><span class="p">(</span><span class="n">mapper</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">polymorphic_key</span> <span class="ow">in</span> <span class="n">dict_</span> <span class="ow">and</span> \
                        <span class="n">dict_</span><span class="p">[</span><span class="n">polymorphic_key</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> \
                        <span class="n">mapper</span><span class="o">.</span><span class="n">_acceptable_polymorphic_identities</span><span class="p">:</span>
                    <span class="n">util</span><span class="o">.</span><span class="n">warn_limited</span><span class="p">(</span>
                        <span class="s">&quot;Flushing object </span><span class="si">%s</span><span class="s"> with &quot;</span>
                        <span class="s">&quot;incompatible polymorphic identity </span><span class="si">%r</span><span class="s">; the &quot;</span>
                        <span class="s">&quot;object may not refresh and/or load correctly&quot;</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">state_str</span><span class="p">(</span><span class="n">state</span><span class="p">),</span> <span class="n">dict_</span><span class="p">[</span><span class="n">polymorphic_key</span><span class="p">])</span>
                    <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_set_polymorphic_identity</span> <span class="o">=</span> <span class="n">_set_polymorphic_identity</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_polymorphic_identity</span> <span class="o">=</span> \
                <span class="n">_validate_polymorphic_identity</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_polymorphic_identity</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">_validate_polymorphic_identity</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="nd">@_memoized_configured_property</span>
    <span class="k">def</span> <span class="nf">_version_id_prop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_id_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columntoproperty</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">version_id_col</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

    <span class="nd">@_memoized_configured_property</span>
    <span class="k">def</span> <span class="nf">_acceptable_polymorphic_identities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">identities</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="n">stack</span> <span class="o">=</span> <span class="n">deque</span><span class="p">([</span><span class="bp">self</span><span class="p">])</span>
        <span class="k">while</span> <span class="n">stack</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">mapped_table</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapped_table</span><span class="p">:</span>
                <span class="n">identities</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">polymorphic_identity</span><span class="p">)</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">_inheriting_mappers</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">identities</span>

    <span class="nd">@_memoized_configured_property</span>
    <span class="k">def</span> <span class="nf">_prop_set</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">frozenset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_adapt_inherited_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">init</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">concrete</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_configure_property</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">setparent</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_configure_property</span><span class="p">(</span>
                <span class="n">key</span><span class="p">,</span>
                <span class="n">properties</span><span class="o">.</span><span class="n">ConcreteInheritedProperty</span><span class="p">(),</span>
                <span class="n">init</span><span class="o">=</span><span class="n">init</span><span class="p">,</span> <span class="n">setparent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_configure_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">setparent</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;_configure_property(</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">)&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">prop</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">MapperProperty</span><span class="p">):</span>
            <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_property_from_column</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">prop</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">properties</span><span class="o">.</span><span class="n">ColumnProperty</span><span class="p">):</span>
            <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapped_table</span><span class="o">.</span><span class="n">corresponding_column</span><span class="p">(</span><span class="n">prop</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="c"># if the column is not present in the mapped table,</span>
            <span class="c"># test if a column has been added after the fact to the</span>
            <span class="c"># parent table (or their parent, etc.) [ticket:1570]</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="o">.</span><span class="n">iterate_to_root</span><span class="p">():</span>
                    <span class="n">col</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">local_table</span><span class="o">.</span><span class="n">corresponding_column</span><span class="p">(</span><span class="n">prop</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">m2</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
                            <span class="n">m2</span><span class="o">.</span><span class="n">mapped_table</span><span class="o">.</span><span class="n">_reset_exported</span><span class="p">()</span>
                        <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapped_table</span><span class="o">.</span><span class="n">corresponding_column</span><span class="p">(</span>
                            <span class="n">prop</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">break</span>
                    <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

            <span class="c"># subquery expression, column not present in the mapped</span>
            <span class="c"># selectable.</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">prop</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="c"># column is coming in after _readonly_props was</span>
                <span class="c"># initialized; check for &#39;readonly&#39;</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_readonly_props&#39;</span><span class="p">)</span> <span class="ow">and</span> \
                    <span class="p">(</span><span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s">&#39;table&#39;</span><span class="p">)</span> <span class="ow">or</span>
                        <span class="n">col</span><span class="o">.</span><span class="n">table</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cols_by_table</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_readonly_props</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c"># if column is coming in after _cols_by_table was</span>
                <span class="c"># initialized, ensure the col is in the right set</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_cols_by_table&#39;</span><span class="p">)</span> <span class="ow">and</span> \
                        <span class="n">col</span><span class="o">.</span><span class="n">table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cols_by_table</span> <span class="ow">and</span> \
                        <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cols_by_table</span><span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">table</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cols_by_table</span><span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">table</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

            <span class="c"># if this properties.ColumnProperty represents the &quot;polymorphic</span>
            <span class="c"># discriminator&quot; column, mark it.  We&#39;ll need this when rendering</span>
            <span class="c"># columns in SELECT statements.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="s">&#39;_is_polymorphic_discriminator&#39;</span><span class="p">):</span>
                <span class="n">prop</span><span class="o">.</span><span class="n">_is_polymorphic_discriminator</span> <span class="o">=</span> \
                    <span class="p">(</span><span class="n">col</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_on</span> <span class="ow">or</span>
                     <span class="n">prop</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_on</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">col</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">prop</span><span class="o">.</span><span class="n">columns</span> <span class="o">+</span> <span class="n">prop</span><span class="o">.</span><span class="n">_orig_columns</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">col</span><span class="o">.</span><span class="n">proxy_set</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_columntoproperty</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">prop</span>

        <span class="n">prop</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span>

        <span class="k">if</span> <span class="n">setparent</span><span class="p">:</span>
            <span class="n">prop</span><span class="o">.</span><span class="n">set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">init</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span> <span class="ow">and</span> \
                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="s">&#39;_mapped_by_synonym&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
            <span class="n">syn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">_mapped_by_synonym</span>
            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                <span class="s">&quot;Can&#39;t call map_column=True for synonym </span><span class="si">%r</span><span class="s">=</span><span class="si">%r</span><span class="s">, &quot;</span>
                <span class="s">&quot;a ColumnProperty already exists keyed to the name &quot;</span>
                <span class="s">&quot;</span><span class="si">%r</span><span class="s"> for column </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">syn</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">syn</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span> <span class="ow">and</span> \
                <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">properties</span><span class="o">.</span><span class="n">ColumnProperty</span><span class="p">)</span> <span class="ow">and</span> \
                <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">properties</span><span class="o">.</span><span class="n">ColumnProperty</span><span class="p">):</span>
            <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Property </span><span class="si">%s</span><span class="s"> on </span><span class="si">%s</span><span class="s"> being replaced with new &quot;</span>
                      <span class="s">&quot;property </span><span class="si">%s</span><span class="s">; the old property will be discarded&quot;</span> <span class="o">%</span> <span class="p">(</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
                          <span class="bp">self</span><span class="p">,</span>
                          <span class="n">prop</span><span class="p">,</span>
                      <span class="p">))</span>
            <span class="n">oldprop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_path_registry</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">oldprop</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">prop</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_primary</span><span class="p">:</span>
            <span class="n">prop</span><span class="o">.</span><span class="n">instrument_class</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">mapper</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inheriting_mappers</span><span class="p">:</span>
            <span class="n">mapper</span><span class="o">.</span><span class="n">_adapt_inherited_property</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">init</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">init</span><span class="p">:</span>
            <span class="n">prop</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
            <span class="n">prop</span><span class="o">.</span><span class="n">post_instrument_class</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">configured</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expire_memoizations</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_property_from_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">prop</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;generate/update a :class:`.ColumnProprerty` given a</span>
<span class="sd">        :class:`.Column` object. &quot;&quot;&quot;</span>

        <span class="c"># we were passed a Column or a list of Columns;</span>
        <span class="c"># generate a properties.ColumnProperty</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
        <span class="n">column</span> <span class="o">=</span> <span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">expression</span><span class="o">.</span><span class="n">_is_column</span><span class="p">(</span><span class="n">column</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                <span class="s">&quot;</span><span class="si">%s</span><span class="s">=</span><span class="si">%r</span><span class="s"> is not an instance of MapperProperty or Column&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">prop</span><span class="p">))</span>

        <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">properties</span><span class="o">.</span><span class="n">ColumnProperty</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits_equated_pairs</span> <span class="ow">or</span>
                <span class="p">(</span><span class="n">prop</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">column</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits_equated_pairs</span>
            <span class="p">)</span> <span class="ow">and</span> \
                    <span class="ow">not</span> <span class="n">prop</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shares_lineage</span><span class="p">(</span><span class="n">column</span><span class="p">)</span> <span class="ow">and</span> \
                    <span class="n">prop</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_id_col</span> <span class="ow">and</span> \
                    <span class="n">column</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_id_col</span><span class="p">:</span>
                <span class="n">warn_only</span> <span class="o">=</span> <span class="n">prop</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;Implicitly combining column </span><span class="si">%s</span><span class="s"> with column &quot;</span>
                       <span class="s">&quot;</span><span class="si">%s</span><span class="s"> under attribute &#39;</span><span class="si">%s</span><span class="s">&#39;.  Please configure one &quot;</span>
                       <span class="s">&quot;or more attributes for these same-named columns &quot;</span>
                       <span class="s">&quot;explicitly.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prop</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">column</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">warn_only</span><span class="p">:</span>
                    <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="c"># existing properties.ColumnProperty from an inheriting</span>
            <span class="c"># mapper. make a copy and append our column to it</span>
            <span class="n">prop</span> <span class="o">=</span> <span class="n">prop</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">prop</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;inserting column to existing list &quot;</span>
                      <span class="s">&quot;in properties.ColumnProperty </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">prop</span>
        <span class="k">elif</span> <span class="n">prop</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span>
                                        <span class="n">properties</span><span class="o">.</span><span class="n">ConcreteInheritedProperty</span><span class="p">):</span>
            <span class="n">mapped_column</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
                <span class="n">mc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapped_table</span><span class="o">.</span><span class="n">corresponding_column</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">mc</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">mc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_table</span><span class="o">.</span><span class="n">corresponding_column</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">mc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="c"># if the column is in the local table but not the</span>
                        <span class="c"># mapped table, this corresponds to adding a</span>
                        <span class="c"># column after the fact to the local table.</span>
                        <span class="c"># [ticket:1523]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">mapped_table</span><span class="o">.</span><span class="n">_reset_exported</span><span class="p">()</span>
                    <span class="n">mc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapped_table</span><span class="o">.</span><span class="n">corresponding_column</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">mc</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                            <span class="s">&quot;When configuring property &#39;</span><span class="si">%s</span><span class="s">&#39; on </span><span class="si">%s</span><span class="s">, &quot;</span>
                            <span class="s">&quot;column &#39;</span><span class="si">%s</span><span class="s">&#39; is not represented in the mapper&#39;s &quot;</span>
                            <span class="s">&quot;table. Use the `column_property()` function to &quot;</span>
                            <span class="s">&quot;force this column to be mapped as a read-only &quot;</span>
                            <span class="s">&quot;attribute.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>
                <span class="n">mapped_column</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mc</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">properties</span><span class="o">.</span><span class="n">ColumnProperty</span><span class="p">(</span><span class="o">*</span><span class="n">mapped_column</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                <span class="s">&quot;WARNING: when configuring property &#39;</span><span class="si">%s</span><span class="s">&#39; on </span><span class="si">%s</span><span class="s">, &quot;</span>
                <span class="s">&quot;column &#39;</span><span class="si">%s</span><span class="s">&#39; conflicts with property &#39;</span><span class="si">%r</span><span class="s">&#39;. &quot;</span>
                <span class="s">&quot;To resolve this, map the column to the class under a &quot;</span>
                <span class="s">&quot;different name in the &#39;properties&#39; dictionary.  Or, &quot;</span>
                <span class="s">&quot;to remove all awareness of the column entirely &quot;</span>
                <span class="s">&quot;(including its availability as a foreign key), &quot;</span>
                <span class="s">&quot;use the &#39;include_properties&#39; or &#39;exclude_properties&#39; &quot;</span>
                <span class="s">&quot;mapper arguments to control specifically which table &quot;</span>
                <span class="s">&quot;columns get mapped.&quot;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">prop</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_post_configure_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Call the ``init()`` method on all ``MapperProperties``</span>
<span class="sd">        attached to this mapper.</span>

<span class="sd">        This is a deferred configuration step which is intended</span>
<span class="sd">        to execute once all mappers have been constructed.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;_post_configure_properties() started&quot;</span><span class="p">)</span>
        <span class="n">l</span> <span class="o">=</span> <span class="p">[(</span><span class="n">key</span><span class="p">,</span> <span class="n">prop</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">prop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;initialize prop </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">prop</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="bp">self</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">prop</span><span class="o">.</span><span class="n">_configure_started</span><span class="p">:</span>
                <span class="n">prop</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">prop</span><span class="o">.</span><span class="n">_configure_finished</span><span class="p">:</span>
                <span class="n">prop</span><span class="o">.</span><span class="n">post_instrument_class</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;_post_configure_properties() complete&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configured</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">add_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dict_of_properties</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add the given dictionary of properties to this mapper,</span>
<span class="sd">        using `add_property`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">dict_of_properties</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_property</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">prop</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add an individual MapperProperty to this mapper.</span>

<span class="sd">        If the mapper has not been configured yet, just adds the</span>
<span class="sd">        property to the initial properties dictionary sent to the</span>
<span class="sd">        constructor.  If this Mapper has already been configured, then</span>
<span class="sd">        the given MapperProperty is configured immediately.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_properties</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">prop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configure_property</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">configured</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_expire_memoizations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">mapper</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterate_to_root</span><span class="p">():</span>
            <span class="n">_memoized_configured_property</span><span class="o">.</span><span class="n">expire_instance</span><span class="p">(</span><span class="n">mapper</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_log_desc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;(&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_</span><span class="o">.</span><span class="n">__name__</span> <span class="o">+</span> \
            <span class="s">&quot;|&quot;</span> <span class="o">+</span> \
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">local_table</span><span class="o">.</span><span class="n">description</span> <span class="ow">or</span>
                <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_table</span><span class="p">))</span> <span class="o">+</span>\
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">non_primary</span> <span class="ow">and</span>
             <span class="s">&quot;|non-primary&quot;</span> <span class="ow">or</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span>

    <span class="k">def</span> <span class="nf">_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s">&quot;</span><span class="si">%s</span><span class="s"> &quot;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_desc</span><span class="p">,)</span> <span class="o">+</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_log_debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s">&quot;</span><span class="si">%s</span><span class="s"> &quot;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_desc</span><span class="p">,)</span> <span class="o">+</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&lt;Mapper at 0x</span><span class="si">%x</span><span class="s">; </span><span class="si">%s</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;Mapper|</span><span class="si">%s</span><span class="s">|</span><span class="si">%s%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">class_</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">local_table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">local_table</span><span class="o">.</span><span class="n">description</span> <span class="ow">or</span> <span class="bp">None</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">non_primary</span> <span class="ow">and</span> <span class="s">&quot;|non-primary&quot;</span> <span class="ow">or</span> <span class="s">&quot;&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_is_orphan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="n">orphan_possible</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">mapper</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterate_to_root</span><span class="p">():</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">cls</span><span class="p">)</span> <span class="ow">in</span> <span class="n">mapper</span><span class="o">.</span><span class="n">_delete_orphans</span><span class="p">:</span>
                <span class="n">orphan_possible</span> <span class="o">=</span> <span class="bp">True</span>

                <span class="n">has_parent</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">manager_of_class</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">has_parent</span><span class="p">(</span>
                    <span class="n">state</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">optimistic</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">has_identity</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">legacy_is_orphan</span> <span class="ow">and</span> <span class="n">has_parent</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">False</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">legacy_is_orphan</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_parent</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">legacy_is_orphan</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">orphan_possible</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">has_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span>

    <span class="k">def</span> <span class="nf">get_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">_configure_mappers</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return a MapperProperty associated with the given key.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">_configure_mappers</span> <span class="ow">and</span> <span class="n">Mapper</span><span class="o">.</span><span class="n">_new_mappers</span><span class="p">:</span>
            <span class="n">configure_mappers</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
                <span class="s">&quot;Mapper &#39;</span><span class="si">%s</span><span class="s">&#39; has no property &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_property_by_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Given a :class:`.Column` object, return the</span>
<span class="sd">        :class:`.MapperProperty` which maps this column.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columntoproperty</span><span class="p">[</span><span class="n">column</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">iterate_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return an iterator of all MapperProperty objects.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">Mapper</span><span class="o">.</span><span class="n">_new_mappers</span><span class="p">:</span>
            <span class="n">configure_mappers</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_mappers_from_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">selectable</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;given a with_polymorphic() argument, return the set of mappers it</span>
<span class="sd">        represents.</span>

<span class="sd">        Trims the list of mappers to just those represented within the given</span>
<span class="sd">        selectable, if present. This helps some more legacy-ish mappings.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">spec</span> <span class="o">==</span> <span class="s">&#39;*&#39;</span><span class="p">:</span>
            <span class="n">mappers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">self_and_descendants</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">spec</span><span class="p">:</span>
            <span class="n">mappers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">util</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="n">spec</span><span class="p">):</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">_class_to_mapper</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="o">.</span><span class="n">isa</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
                        <span class="s">&quot;</span><span class="si">%r</span><span class="s"> does not inherit from </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span>
                        <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">selectable</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">mappers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">iterate_to_root</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mappers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="n">mappers</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">self_and_descendants</span> <span class="k">if</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mappers</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mappers</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">selectable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">tables</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">sql_util</span><span class="o">.</span><span class="n">find_tables</span><span class="p">(</span><span class="n">selectable</span><span class="p">,</span>
                                              <span class="n">include_aliases</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
            <span class="n">mappers</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mappers</span> <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">local_table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">mappers</span>

    <span class="k">def</span> <span class="nf">_selectable_from_mappers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mappers</span><span class="p">,</span> <span class="n">innerjoin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;given a list of mappers (assumed to be within this mapper&#39;s</span>
<span class="sd">        inheritance hierarchy), construct an outerjoin amongst those mapper&#39;s</span>
<span class="sd">        mapped tables.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">from_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapped_table</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mappers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="bp">self</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">concrete</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
                    <span class="s">&quot;&#39;with_polymorphic()&#39; requires &#39;selectable&#39; argument &quot;</span>
                    <span class="s">&quot;when concrete-inheriting mappers are used.&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">m</span><span class="o">.</span><span class="n">single</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">innerjoin</span><span class="p">:</span>
                    <span class="n">from_obj</span> <span class="o">=</span> <span class="n">from_obj</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">local_table</span><span class="p">,</span>
                                             <span class="n">m</span><span class="o">.</span><span class="n">inherit_condition</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">from_obj</span> <span class="o">=</span> <span class="n">from_obj</span><span class="o">.</span><span class="n">outerjoin</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">local_table</span><span class="p">,</span>
                                                  <span class="n">m</span><span class="o">.</span><span class="n">inherit_condition</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">from_obj</span>

    <span class="nd">@_memoized_configured_property</span>
    <span class="k">def</span> <span class="nf">_single_table_criterion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">single</span> <span class="ow">and</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span> <span class="ow">and</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_on</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_on</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span>
                <span class="n">m</span><span class="o">.</span><span class="n">polymorphic_identity</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">self_and_descendants</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

    <span class="nd">@_memoized_configured_property</span>
    <span class="k">def</span> <span class="nf">_with_polymorphic_mappers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">Mapper</span><span class="o">.</span><span class="n">_new_mappers</span><span class="p">:</span>
            <span class="n">configure_mappers</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_polymorphic</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mappers_from_spec</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">with_polymorphic</span><span class="p">)</span>

    <span class="nd">@_memoized_configured_property</span>
    <span class="k">def</span> <span class="nf">_with_polymorphic_selectable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_polymorphic</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapped_table</span>

        <span class="n">spec</span><span class="p">,</span> <span class="n">selectable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_polymorphic</span>
        <span class="k">if</span> <span class="n">selectable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">selectable</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selectable_from_mappers</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mappers_from_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">selectable</span><span class="p">),</span>
                <span class="bp">False</span><span class="p">)</span>

    <span class="n">with_polymorphic_mappers</span> <span class="o">=</span> <span class="n">_with_polymorphic_mappers</span>
    <span class="sd">&quot;&quot;&quot;The list of :class:`.Mapper` objects included in the</span>
<span class="sd">    default &quot;polymorphic&quot; query.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@_memoized_configured_property</span>
    <span class="k">def</span> <span class="nf">_insert_cols_as_none</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">table</span><span class="p">,</span>
                <span class="nb">frozenset</span><span class="p">(</span>
                    <span class="n">col</span><span class="o">.</span><span class="n">key</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">col</span><span class="o">.</span><span class="n">primary_key</span> <span class="ow">and</span>
                    <span class="ow">not</span> <span class="n">col</span><span class="o">.</span><span class="n">server_default</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">col</span><span class="o">.</span><span class="n">default</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">table</span><span class="p">,</span> <span class="n">columns</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cols_by_table</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="nd">@_memoized_configured_property</span>
    <span class="k">def</span> <span class="nf">_propkey_to_col</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">table</span><span class="p">,</span>
                <span class="nb">dict</span><span class="p">(</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_columntoproperty</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">table</span><span class="p">,</span> <span class="n">columns</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cols_by_table</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="nd">@_memoized_configured_property</span>
    <span class="k">def</span> <span class="nf">_pk_keys_by_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">table</span><span class="p">,</span>
                <span class="nb">frozenset</span><span class="p">([</span><span class="n">col</span><span class="o">.</span><span class="n">key</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">pks</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">table</span><span class="p">,</span> <span class="n">pks</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pks_by_table</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="nd">@_memoized_configured_property</span>
    <span class="k">def</span> <span class="nf">_server_default_cols</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">table</span><span class="p">,</span>
                <span class="nb">frozenset</span><span class="p">([</span>
                    <span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span>
                    <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">server_default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">table</span><span class="p">,</span> <span class="n">columns</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cols_by_table</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">selectable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The :func:`.select` construct this :class:`.Mapper` selects from</span>
<span class="sd">        by default.</span>

<span class="sd">        Normally, this is equivalent to :attr:`.mapped_table`, unless</span>
<span class="sd">        the ``with_polymorphic`` feature is in use, in which case the</span>
<span class="sd">        full &quot;polymorphic&quot; selectable is returned.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_with_polymorphic_selectable</span>

    <span class="k">def</span> <span class="nf">_with_polymorphic_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">selectable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                               <span class="n">innerjoin</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_polymorphic</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">spec</span><span class="p">:</span>
                <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_polymorphic</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">selectable</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
                <span class="n">selectable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_polymorphic</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">selectable</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="n">selectable</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">mappers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mappers_from_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">selectable</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">selectable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mappers</span><span class="p">,</span> <span class="n">selectable</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mappers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selectable_from_mappers</span><span class="p">(</span><span class="n">mappers</span><span class="p">,</span>
                                                          <span class="n">innerjoin</span><span class="p">)</span>

    <span class="nd">@_memoized_configured_property</span>
    <span class="k">def</span> <span class="nf">_polymorphic_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_iterate_polymorphic_properties</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_with_polymorphic_mappers</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_iterate_polymorphic_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mappers</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an iterator of MapperProperty objects which will render into</span>
<span class="sd">        a SELECT.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mappers</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">mappers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_with_polymorphic_mappers</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">mappers</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterate_properties</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">c</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># in the polymorphic case, filter out discriminator columns</span>
            <span class="c"># from other mappers, as these are sometimes dependent on that</span>
            <span class="c"># mapper&#39;s polymorphic selectable (which we don&#39;t want rendered)</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">util</span><span class="o">.</span><span class="n">unique_list</span><span class="p">(</span>
                <span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="p">[</span>
                    <span class="nb">list</span><span class="p">(</span><span class="n">mapper</span><span class="o">.</span><span class="n">iterate_properties</span><span class="p">)</span> <span class="k">for</span> <span class="n">mapper</span> <span class="ow">in</span>
                    <span class="p">[</span><span class="bp">self</span><span class="p">]</span> <span class="o">+</span> <span class="n">mappers</span>
                <span class="p">])</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s">&#39;_is_polymorphic_discriminator&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span> <span class="ow">and</span> \
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_on</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span>
                         <span class="n">c</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_on</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">yield</span> <span class="n">c</span>

    <span class="nd">@util.memoized_property</span>
    <span class="k">def</span> <span class="nf">attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A namespace of all :class:`.MapperProperty` objects</span>
<span class="sd">        associated this mapper.</span>

<span class="sd">        This is an object that provides each property based on</span>
<span class="sd">        its key name.  For instance, the mapper for a</span>
<span class="sd">        ``User`` class which has ``User.name`` attribute would</span>
<span class="sd">        provide ``mapper.attrs.name``, which would be the</span>
<span class="sd">        :class:`.ColumnProperty` representing the ``name``</span>
<span class="sd">        column.   The namespace object can also be iterated,</span>
<span class="sd">        which would yield each :class:`.MapperProperty`.</span>

<span class="sd">        :class:`.Mapper` has several pre-filtered views</span>
<span class="sd">        of this attribute which limit the types of properties</span>
<span class="sd">        returned, inclding :attr:`.synonyms`, :attr:`.column_attrs`,</span>
<span class="sd">        :attr:`.relationships`, and :attr:`.composites`.</span>

<span class="sd">        .. warning::</span>

<span class="sd">            the :attr:`.Mapper.relationships` accessor namespace is an</span>
<span class="sd">            instance of :class:`.OrderedProperties`.  This is</span>
<span class="sd">            a dictionary-like object which includes a small number of</span>
<span class="sd">            named methods such as :meth:`.OrderedProperties.items`</span>
<span class="sd">            and :meth:`.OrderedProperties.values`.  When</span>
<span class="sd">            accessing attributes dynamically, favor using the dict-access</span>
<span class="sd">            scheme, e.g. ``mapper.attrs[somename]`` over</span>
<span class="sd">            ``getattr(mapper.attrs, somename)`` to avoid name collisions.</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            :attr:`.Mapper.all_orm_descriptors`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">Mapper</span><span class="o">.</span><span class="n">_new_mappers</span><span class="p">:</span>
            <span class="n">configure_mappers</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">util</span><span class="o">.</span><span class="n">ImmutableProperties</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">)</span>

    <span class="nd">@util.memoized_property</span>
    <span class="k">def</span> <span class="nf">all_orm_descriptors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A namespace of all :class:`.InspectionAttr` attributes associated</span>
<span class="sd">        with the mapped class.</span>

<span class="sd">        These attributes are in all cases Python :term:`descriptors`</span>
<span class="sd">        associated with the mapped class or its superclasses.</span>

<span class="sd">        This namespace includes attributes that are mapped to the class</span>
<span class="sd">        as well as attributes declared by extension modules.</span>
<span class="sd">        It includes any Python descriptor type that inherits from</span>
<span class="sd">        :class:`.InspectionAttr`.  This includes</span>
<span class="sd">        :class:`.QueryableAttribute`, as well as extension types such as</span>
<span class="sd">        :class:`.hybrid_property`, :class:`.hybrid_method` and</span>
<span class="sd">        :class:`.AssociationProxy`.</span>

<span class="sd">        To distinguish between mapped attributes and extension attributes,</span>
<span class="sd">        the attribute :attr:`.InspectionAttr.extension_type` will refer</span>
<span class="sd">        to a constant that distinguishes between different extension types.</span>

<span class="sd">        When dealing with a :class:`.QueryableAttribute`, the</span>
<span class="sd">        :attr:`.QueryableAttribute.property` attribute refers to the</span>
<span class="sd">        :class:`.MapperProperty` property, which is what you get when</span>
<span class="sd">        referring to the collection of mapped properties via</span>
<span class="sd">        :attr:`.Mapper.attrs`.</span>

<span class="sd">        .. warning::</span>

<span class="sd">            the :attr:`.Mapper.relationships` accessor namespace is an</span>
<span class="sd">            instance of :class:`.OrderedProperties`.  This is</span>
<span class="sd">            a dictionary-like object which includes a small number of</span>
<span class="sd">            named methods such as :meth:`.OrderedProperties.items`</span>
<span class="sd">            and :meth:`.OrderedProperties.values`.  When</span>
<span class="sd">            accessing attributes dynamically, favor using the dict-access</span>
<span class="sd">            scheme, e.g. ``mapper.attrs[somename]`` over</span>
<span class="sd">            ``getattr(mapper.attrs, somename)`` to avoid name collisions.</span>

<span class="sd">        .. versionadded:: 0.8.0</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            :attr:`.Mapper.attrs`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">util</span><span class="o">.</span><span class="n">ImmutableProperties</span><span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_manager</span><span class="o">.</span><span class="n">_all_sqla_attributes</span><span class="p">()))</span>

    <span class="nd">@_memoized_configured_property</span>
    <span class="k">def</span> <span class="nf">synonyms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a namespace of all :class:`.SynonymProperty`</span>
<span class="sd">        properties maintained by this :class:`.Mapper`.</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            :attr:`.Mapper.attrs` - namespace of all :class:`.MapperProperty`</span>
<span class="sd">            objects.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_properties</span><span class="p">(</span><span class="n">properties</span><span class="o">.</span><span class="n">SynonymProperty</span><span class="p">)</span>

    <span class="nd">@_memoized_configured_property</span>
    <span class="k">def</span> <span class="nf">column_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a namespace of all :class:`.ColumnProperty`</span>
<span class="sd">        properties maintained by this :class:`.Mapper`.</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            :attr:`.Mapper.attrs` - namespace of all :class:`.MapperProperty`</span>
<span class="sd">            objects.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_properties</span><span class="p">(</span><span class="n">properties</span><span class="o">.</span><span class="n">ColumnProperty</span><span class="p">)</span>

    <span class="nd">@_memoized_configured_property</span>
    <span class="k">def</span> <span class="nf">relationships</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a namespace of all :class:`.RelationshipProperty`</span>
<span class="sd">        properties maintained by this :class:`.Mapper`.</span>

<span class="sd">        .. warning::</span>

<span class="sd">            the :attr:`.Mapper.relationships` accessor namespace is an</span>
<span class="sd">            instance of :class:`.OrderedProperties`.  This is</span>
<span class="sd">            a dictionary-like object which includes a small number of</span>
<span class="sd">            named methods such as :meth:`.OrderedProperties.items`</span>
<span class="sd">            and :meth:`.OrderedProperties.values`.  When</span>
<span class="sd">            accessing attributes dynamically, favor using the dict-access</span>
<span class="sd">            scheme, e.g. ``mapper.attrs[somename]`` over</span>
<span class="sd">            ``getattr(mapper.attrs, somename)`` to avoid name collisions.</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            :attr:`.Mapper.attrs` - namespace of all :class:`.MapperProperty`</span>
<span class="sd">            objects.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_properties</span><span class="p">(</span><span class="n">properties</span><span class="o">.</span><span class="n">RelationshipProperty</span><span class="p">)</span>

    <span class="nd">@_memoized_configured_property</span>
    <span class="k">def</span> <span class="nf">composites</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a namespace of all :class:`.CompositeProperty`</span>
<span class="sd">        properties maintained by this :class:`.Mapper`.</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            :attr:`.Mapper.attrs` - namespace of all :class:`.MapperProperty`</span>
<span class="sd">            objects.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_properties</span><span class="p">(</span><span class="n">properties</span><span class="o">.</span><span class="n">CompositeProperty</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_filter_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">Mapper</span><span class="o">.</span><span class="n">_new_mappers</span><span class="p">:</span>
            <span class="n">configure_mappers</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">util</span><span class="o">.</span><span class="n">ImmutableProperties</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(</span>
            <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">type_</span><span class="p">)</span>
        <span class="p">))</span>

    <span class="nd">@_memoized_configured_property</span>
    <span class="k">def</span> <span class="nf">_get_clause</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;create a &quot;get clause&quot; based on the primary key.  this is used</span>
<span class="sd">        by query.get() and many-to-one lazyloads to load this item</span>
<span class="sd">        by primary key.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[(</span><span class="n">primary_key</span><span class="p">,</span> <span class="n">sql</span><span class="o">.</span><span class="n">bindparam</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">type_</span><span class="o">=</span><span class="n">primary_key</span><span class="o">.</span><span class="n">type</span><span class="p">))</span>
                  <span class="k">for</span> <span class="n">primary_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">sql</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">k</span> <span class="o">==</span> <span class="n">v</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">params</span><span class="p">]),</span> \
            <span class="n">util</span><span class="o">.</span><span class="n">column_dict</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="nd">@_memoized_configured_property</span>
    <span class="k">def</span> <span class="nf">_equivalent_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a map of all *equivalent* columns, based on</span>
<span class="sd">        the determination of column pairs that are equated to</span>
<span class="sd">        one another based on inherit condition.  This is designed</span>
<span class="sd">        to work with the queries that util.polymorphic_union</span>
<span class="sd">        comes up with, which often don&#39;t include the columns from</span>
<span class="sd">        the base table directly (including the subclass table columns</span>
<span class="sd">        only).</span>

<span class="sd">        The resulting structure is a dictionary of columns mapped</span>
<span class="sd">        to lists of equivalent columns, i.e.</span>

<span class="sd">        {</span>
<span class="sd">            tablea.col1:</span>
<span class="sd">                set([tableb.col1, tablec.col1]),</span>
<span class="sd">            tablea.col2:</span>
<span class="sd">                set([tabled.col2])</span>
<span class="sd">        }</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">column_dict</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">visit_binary</span><span class="p">(</span><span class="n">binary</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">binary</span><span class="o">.</span><span class="n">operator</span> <span class="o">==</span> <span class="n">operators</span><span class="o">.</span><span class="n">eq</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">binary</span><span class="o">.</span><span class="n">left</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">binary</span><span class="o">.</span><span class="n">left</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">binary</span><span class="o">.</span><span class="n">right</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">binary</span><span class="o">.</span><span class="n">left</span><span class="p">]</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">column_set</span><span class="p">((</span><span class="n">binary</span><span class="o">.</span><span class="n">right</span><span class="p">,))</span>
                <span class="k">if</span> <span class="n">binary</span><span class="o">.</span><span class="n">right</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">binary</span><span class="o">.</span><span class="n">right</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">binary</span><span class="o">.</span><span class="n">left</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">binary</span><span class="o">.</span><span class="n">right</span><span class="p">]</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">column_set</span><span class="p">((</span><span class="n">binary</span><span class="o">.</span><span class="n">left</span><span class="p">,))</span>
        <span class="k">for</span> <span class="n">mapper</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_mapper</span><span class="o">.</span><span class="n">self_and_descendants</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mapper</span><span class="o">.</span><span class="n">inherit_condition</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">visitors</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span>
                    <span class="n">mapper</span><span class="o">.</span><span class="n">inherit_condition</span><span class="p">,</span> <span class="p">{},</span>
                    <span class="p">{</span><span class="s">&#39;binary&#39;</span><span class="p">:</span> <span class="n">visit_binary</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_is_userland_descriptor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">_MappedAttribute</span><span class="p">,</span>
                            <span class="n">instrumentation</span><span class="o">.</span><span class="n">ClassManager</span><span class="p">,</span>
                            <span class="n">expression</span><span class="o">.</span><span class="n">ColumnElement</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">_should_exclude</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">assigned_name</span><span class="p">,</span> <span class="n">local</span><span class="p">,</span> <span class="n">column</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;determine whether a particular property should be implicitly</span>
<span class="sd">        present on the class.</span>

<span class="sd">        This occurs when properties are propagated from an inherited class, or</span>
<span class="sd">        are applied from the columns present in the mapped table.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># check for class-bound attributes and/or descriptors,</span>
        <span class="c"># either local or from an inherited class</span>
        <span class="k">if</span> <span class="n">local</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">assigned_name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> \
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_userland_descriptor</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">class_</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">assigned_name</span><span class="p">]):</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_</span><span class="p">,</span> <span class="n">assigned_name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> \
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_userland_descriptor</span><span class="p">(</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_</span><span class="p">,</span> <span class="n">assigned_name</span><span class="p">)):</span>
                <span class="k">return</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_properties</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> \
                <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_properties</span> <span class="ow">and</span> \
                <span class="p">(</span><span class="n">column</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">column</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_properties</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;not including property </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exclude_properties</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> \
                <span class="p">(</span>
                    <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exclude_properties</span> <span class="ow">or</span>
                    <span class="p">(</span><span class="n">column</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">column</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exclude_properties</span><span class="p">)</span>
                <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s">&quot;excluding property </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">True</span>

        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">common_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return true if the given mapper shares a</span>
<span class="sd">        common inherited parent as this mapper.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_mapper</span> <span class="ow">is</span> <span class="n">other</span><span class="o">.</span><span class="n">base_mapper</span>

    <span class="k">def</span> <span class="nf">_canload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">allow_subtypes</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_mapper</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_on</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">allow_subtypes</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_state_mapper</span><span class="p">(</span><span class="n">state</span><span class="p">)</span><span class="o">.</span><span class="n">isa</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_state_mapper</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="ow">is</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">isa</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return True if the this mapper inherits from the given mapper.&quot;&quot;&quot;</span>

        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">while</span> <span class="n">m</span> <span class="ow">and</span> <span class="n">m</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">other</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">inherits</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">iterate_to_root</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">while</span> <span class="n">m</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">m</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">inherits</span>

    <span class="nd">@_memoized_configured_property</span>
    <span class="k">def</span> <span class="nf">self_and_descendants</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The collection including this mapper and all descendant mappers.</span>

<span class="sd">        This includes not just the immediately inheriting mappers but</span>
<span class="sd">        all their inheriting mappers as well.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">descendants</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="n">deque</span><span class="p">([</span><span class="bp">self</span><span class="p">])</span>
        <span class="k">while</span> <span class="n">stack</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
            <span class="n">descendants</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">_inheriting_mappers</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">util</span><span class="o">.</span><span class="n">WeakSequence</span><span class="p">(</span><span class="n">descendants</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">polymorphic_iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterate through the collection including this mapper and</span>
<span class="sd">        all descendant mappers.</span>

<span class="sd">        This includes not just the immediately inheriting mappers but</span>
<span class="sd">        all their inheriting mappers as well.</span>

<span class="sd">        To iterate through an entire hierarchy, use</span>
<span class="sd">        ``mapper.base_mapper.polymorphic_iterator()``.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">self_and_descendants</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">primary_mapper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the primary mapper corresponding to this mapper&#39;s class key</span>
<span class="sd">        (class).&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_manager</span><span class="o">.</span><span class="n">mapper</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">primary_base_mapper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_manager</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">base_mapper</span>

    <span class="k">def</span> <span class="nf">_result_has_identity_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">adapter</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">pk_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span>
        <span class="k">if</span> <span class="n">adapter</span><span class="p">:</span>
            <span class="n">pk_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">adapter</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">pk_cols</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">pk_cols</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">_has_key</span><span class="p">(</span><span class="n">col</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">identity_key_from_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">adapter</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an identity-map key for use in storing/retrieving an</span>
<span class="sd">        item from the identity map.</span>

<span class="sd">        :param row: A :class:`.RowProxy` instance.  The columns which are</span>
<span class="sd">         mapped by this :class:`.Mapper` should be locatable in the row,</span>
<span class="sd">         preferably via the :class:`.Column` object directly (as is the case</span>
<span class="sd">         when a :func:`.select` construct is executed), or via string names of</span>
<span class="sd">         the form ``&lt;tablename&gt;_&lt;colname&gt;``.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pk_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span>
        <span class="k">if</span> <span class="n">adapter</span><span class="p">:</span>
            <span class="n">pk_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">adapter</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">pk_cols</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identity_class</span><span class="p">,</span> \
            <span class="nb">tuple</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">pk_cols</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">identity_key_from_primary_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">primary_key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an identity-map key for use in storing/retrieving an</span>
<span class="sd">        item from an identity map.</span>

<span class="sd">        :param primary_key: A list of values indicating the identifier.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identity_class</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">primary_key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">identity_key_from_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the identity key for the given instance, based on</span>
<span class="sd">        its primary key attributes.</span>

<span class="sd">        If the instance&#39;s state is expired, calling this method</span>
<span class="sd">        will result in a database check to see if the object has been deleted.</span>
<span class="sd">        If the row no longer exists,</span>
<span class="sd">        :class:`~sqlalchemy.orm.exc.ObjectDeletedError` is raised.</span>

<span class="sd">        This value is typically also found on the instance state under the</span>
<span class="sd">        attribute name `key`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity_key_from_primary_key</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">primary_key_from_instance</span><span class="p">(</span><span class="n">instance</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_identity_key_from_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="n">dict_</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">dict</span>
        <span class="n">manager</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">manager</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identity_class</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">([</span>
            <span class="n">manager</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_columntoproperty</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">key</span><span class="p">]</span><span class="o">.</span>
            <span class="n">impl</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">attributes</span><span class="o">.</span><span class="n">PASSIVE_RETURN_NEVER_SET</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span>
        <span class="p">])</span>

    <span class="k">def</span> <span class="nf">primary_key_from_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the list of primary key values for the given</span>
<span class="sd">        instance.</span>

<span class="sd">        If the instance&#39;s state is expired, calling this method</span>
<span class="sd">        will result in a database check to see if the object has been deleted.</span>
<span class="sd">        If the row no longer exists,</span>
<span class="sd">        :class:`~sqlalchemy.orm.exc.ObjectDeletedError` is raised.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">instance_state</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_primary_key_from_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">attributes</span><span class="o">.</span><span class="n">PASSIVE_OFF</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_primary_key_from_state</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">passive</span><span class="o">=</span><span class="n">attributes</span><span class="o">.</span><span class="n">PASSIVE_RETURN_NEVER_SET</span><span class="p">):</span>
        <span class="n">dict_</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">dict</span>
        <span class="n">manager</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">manager</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">manager</span><span class="p">[</span><span class="n">prop</span><span class="o">.</span><span class="n">key</span><span class="p">]</span><span class="o">.</span>
            <span class="n">impl</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">passive</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identity_key_props</span>
        <span class="p">]</span>

    <span class="nd">@_memoized_configured_property</span>
    <span class="k">def</span> <span class="nf">_identity_key_props</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_columntoproperty</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">]</span>

    <span class="nd">@_memoized_configured_property</span>
    <span class="k">def</span> <span class="nf">_all_pk_props</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">collection</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">:</span>
            <span class="n">collection</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pks_by_table</span><span class="p">[</span><span class="n">table</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">collection</span>

    <span class="nd">@_memoized_configured_property</span>
    <span class="k">def</span> <span class="nf">_should_undefer_in_wildcard</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_on</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polymorphic_on</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cols</span>

    <span class="nd">@_memoized_configured_property</span>
    <span class="k">def</span> <span class="nf">_primary_key_propkeys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">([</span><span class="n">prop</span><span class="o">.</span><span class="n">key</span> <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_pk_props</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_get_state_attr_by_column</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span>
            <span class="n">passive</span><span class="o">=</span><span class="n">attributes</span><span class="o">.</span><span class="n">PASSIVE_RETURN_NEVER_SET</span><span class="p">):</span>
        <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columntoproperty</span><span class="p">[</span><span class="n">column</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">state</span><span class="o">.</span><span class="n">manager</span><span class="p">[</span><span class="n">prop</span><span class="o">.</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">passive</span><span class="o">=</span><span class="n">passive</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_committed_state_attr_by_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columntoproperty</span><span class="p">[</span><span class="n">column</span><span class="p">]</span>
        <span class="n">state</span><span class="o">.</span><span class="n">manager</span><span class="p">[</span><span class="n">prop</span><span class="o">.</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">set_committed_value</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_state_attr_by_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columntoproperty</span><span class="p">[</span><span class="n">column</span><span class="p">]</span>
        <span class="n">state</span><span class="o">.</span><span class="n">manager</span><span class="p">[</span><span class="n">prop</span><span class="o">.</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_committed_attr_by_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">column</span><span class="p">):</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">instance_state</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">dict_</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">instance_dict</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_committed_state_attr_by_column</span><span class="p">(</span>
            <span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">passive</span><span class="o">=</span><span class="n">attributes</span><span class="o">.</span><span class="n">PASSIVE_OFF</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_committed_state_attr_by_column</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span>
            <span class="n">passive</span><span class="o">=</span><span class="n">attributes</span><span class="o">.</span><span class="n">PASSIVE_RETURN_NEVER_SET</span><span class="p">):</span>

        <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columntoproperty</span><span class="p">[</span><span class="n">column</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">state</span><span class="o">.</span><span class="n">manager</span><span class="p">[</span><span class="n">prop</span><span class="o">.</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span>\
            <span class="n">get_committed_value</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">passive</span><span class="o">=</span><span class="n">passive</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_optimized_get_statement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">attribute_names</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;assemble a WHERE clause which retrieves a given state by primary</span>
<span class="sd">        key, using a minimized set of tables.</span>

<span class="sd">        Applies to a joined-table inheritance mapper where the</span>
<span class="sd">        requested attribute names are only present on joined tables,</span>
<span class="sd">        not the base table.  The WHERE clause attempts to include</span>
<span class="sd">        only those tables to minimize joins.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span>

        <span class="n">tables</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span>
            <span class="o">*</span><span class="p">[</span><span class="n">sql_util</span><span class="o">.</span><span class="n">find_tables</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">check_columns</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
              <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">attribute_names</span>
              <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">props</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_mapper</span><span class="o">.</span><span class="n">local_table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="k">class</span> <span class="nc">ColumnsNotAvailable</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="k">pass</span>

        <span class="k">def</span> <span class="nf">visit_binary</span><span class="p">(</span><span class="n">binary</span><span class="p">):</span>
            <span class="n">leftcol</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">left</span>
            <span class="n">rightcol</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">right</span>
            <span class="k">if</span> <span class="n">leftcol</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">rightcol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="n">leftcol</span><span class="o">.</span><span class="n">table</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
                <span class="n">leftval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_committed_state_attr_by_column</span><span class="p">(</span>
                    <span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">dict</span><span class="p">,</span>
                    <span class="n">leftcol</span><span class="p">,</span>
                    <span class="n">passive</span><span class="o">=</span><span class="n">attributes</span><span class="o">.</span><span class="n">PASSIVE_NO_INITIALIZE</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">leftval</span> <span class="ow">in</span> <span class="n">orm_util</span><span class="o">.</span><span class="n">_none_set</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ColumnsNotAvailable</span><span class="p">()</span>
                <span class="n">binary</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">bindparam</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">leftval</span><span class="p">,</span>
                                            <span class="n">type_</span><span class="o">=</span><span class="n">binary</span><span class="o">.</span><span class="n">right</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">rightcol</span><span class="o">.</span><span class="n">table</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
                <span class="n">rightval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_committed_state_attr_by_column</span><span class="p">(</span>
                    <span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">dict</span><span class="p">,</span>
                    <span class="n">rightcol</span><span class="p">,</span>
                    <span class="n">passive</span><span class="o">=</span><span class="n">attributes</span><span class="o">.</span><span class="n">PASSIVE_NO_INITIALIZE</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">rightval</span> <span class="ow">in</span> <span class="n">orm_util</span><span class="o">.</span><span class="n">_none_set</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ColumnsNotAvailable</span><span class="p">()</span>
                <span class="n">binary</span><span class="o">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">bindparam</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">rightval</span><span class="p">,</span>
                                             <span class="n">type_</span><span class="o">=</span><span class="n">binary</span><span class="o">.</span><span class="n">right</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>

        <span class="n">allconds</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">for</span> <span class="n">mapper</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iterate_to_root</span><span class="p">())):</span>
                <span class="k">if</span> <span class="n">mapper</span><span class="o">.</span><span class="n">local_table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
                    <span class="n">start</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mapper</span><span class="o">.</span><span class="n">local_table</span><span class="p">,</span>
                                    <span class="n">expression</span><span class="o">.</span><span class="n">TableClause</span><span class="p">):</span>
                    <span class="k">return</span> <span class="bp">None</span>
                <span class="k">if</span> <span class="n">start</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">mapper</span><span class="o">.</span><span class="n">single</span><span class="p">:</span>
                    <span class="n">allconds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">visitors</span><span class="o">.</span><span class="n">cloned_traverse</span><span class="p">(</span>
                        <span class="n">mapper</span><span class="o">.</span><span class="n">inherit_condition</span><span class="p">,</span>
                        <span class="p">{},</span>
                        <span class="p">{</span><span class="s">&#39;binary&#39;</span><span class="p">:</span> <span class="n">visit_binary</span><span class="p">}</span>
                    <span class="p">)</span>
                    <span class="p">)</span>
        <span class="k">except</span> <span class="n">ColumnsNotAvailable</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="n">cond</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span><span class="o">*</span><span class="n">allconds</span><span class="p">)</span>

        <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">attribute_names</span><span class="p">:</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">props</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sql</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="n">cond</span><span class="p">,</span> <span class="n">use_labels</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">cascade_iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">halt_on</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterate each element and its mapper in an object graph,</span>
<span class="sd">        for all relationships that meet the given cascade rule.</span>

<span class="sd">        :param type_:</span>
<span class="sd">          The name of the cascade rule (i.e. ``&quot;save-update&quot;``, ``&quot;delete&quot;``,</span>
<span class="sd">          etc.).</span>

<span class="sd">          .. note::  the ``&quot;all&quot;`` cascade is not accepted here.  For a generic</span>
<span class="sd">             object traversal function, see :ref:`faq_walk_objects`.</span>

<span class="sd">        :param state:</span>
<span class="sd">          The lead InstanceState.  child items will be processed per</span>
<span class="sd">          the relationships defined for this object&#39;s mapper.</span>

<span class="sd">        :return: the method yields individual object instances.</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            :ref:`unitofwork_cascades`</span>

<span class="sd">            :ref:`faq_walk_objects` - illustrates a generic function to</span>
<span class="sd">            traverse all objects without relying on cascades.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">visited_states</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">prp</span><span class="p">,</span> <span class="n">mpp</span> <span class="o">=</span> <span class="nb">object</span><span class="p">(),</span> <span class="nb">object</span><span class="p">()</span>

        <span class="n">visitables</span> <span class="o">=</span> <span class="n">deque</span><span class="p">([(</span><span class="n">deque</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">prp</span><span class="p">,</span>
                             <span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">dict</span><span class="p">)])</span>

        <span class="k">while</span> <span class="n">visitables</span><span class="p">:</span>
            <span class="n">iterator</span><span class="p">,</span> <span class="n">item_type</span><span class="p">,</span> <span class="n">parent_state</span><span class="p">,</span> <span class="n">parent_dict</span> <span class="o">=</span> <span class="n">visitables</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">iterator</span><span class="p">:</span>
                <span class="n">visitables</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">item_type</span> <span class="ow">is</span> <span class="n">prp</span><span class="p">:</span>
                <span class="n">prop</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">type_</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">prop</span><span class="o">.</span><span class="n">cascade</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">queue</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">prop</span><span class="o">.</span><span class="n">cascade_iterator</span><span class="p">(</span>
                    <span class="n">type_</span><span class="p">,</span> <span class="n">parent_state</span><span class="p">,</span> <span class="n">parent_dict</span><span class="p">,</span>
                    <span class="n">visited_states</span><span class="p">,</span> <span class="n">halt_on</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">queue</span><span class="p">:</span>
                    <span class="n">visitables</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">queue</span><span class="p">,</span> <span class="n">mpp</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">item_type</span> <span class="ow">is</span> <span class="n">mpp</span><span class="p">:</span>
                <span class="n">instance</span><span class="p">,</span> <span class="n">instance_mapper</span><span class="p">,</span> <span class="n">corresponding_state</span><span class="p">,</span> \
                    <span class="n">corresponding_dict</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
                <span class="k">yield</span> <span class="n">instance</span><span class="p">,</span> <span class="n">instance_mapper</span><span class="p">,</span> \
                    <span class="n">corresponding_state</span><span class="p">,</span> <span class="n">corresponding_dict</span>
                <span class="n">visitables</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">deque</span><span class="p">(</span><span class="n">instance_mapper</span><span class="o">.</span><span class="n">_props</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                                   <span class="n">prp</span><span class="p">,</span> <span class="n">corresponding_state</span><span class="p">,</span>
                                   <span class="n">corresponding_dict</span><span class="p">))</span>

    <span class="nd">@_memoized_configured_property</span>
    <span class="k">def</span> <span class="nf">_compiled_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">util</span><span class="o">.</span><span class="n">LRUCache</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_compiled_cache_size</span><span class="p">)</span>

    <span class="nd">@_memoized_configured_property</span>
    <span class="k">def</span> <span class="nf">_sorted_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">table_to_mapper</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">mapper</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_mapper</span><span class="o">.</span><span class="n">self_and_descendants</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">mapper</span><span class="o">.</span><span class="n">tables</span><span class="p">:</span>
                <span class="n">table_to_mapper</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">mapper</span><span class="p">)</span>

        <span class="n">extra_dependencies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">table</span><span class="p">,</span> <span class="n">mapper</span> <span class="ow">in</span> <span class="n">table_to_mapper</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">super_</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="n">inherits</span>
            <span class="k">if</span> <span class="n">super_</span><span class="p">:</span>
                <span class="n">extra_dependencies</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
                    <span class="p">(</span><span class="n">super_table</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">super_table</span> <span class="ow">in</span> <span class="n">super_</span><span class="o">.</span><span class="n">tables</span>
                <span class="p">])</span>

        <span class="k">def</span> <span class="nf">skip</span><span class="p">(</span><span class="n">fk</span><span class="p">):</span>
            <span class="c"># attempt to skip dependencies that are not</span>
            <span class="c"># significant to the inheritance chain</span>
            <span class="c"># for two tables that are related by inheritance.</span>
            <span class="c"># while that dependency may be important, it&#39;s technically</span>
            <span class="c"># not what we mean to sort on here.</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">table_to_mapper</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fk</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>
            <span class="n">dep</span> <span class="o">=</span> <span class="n">table_to_mapper</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fk</span><span class="o">.</span><span class="n">column</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> \
                <span class="n">dep</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> \
                <span class="n">dep</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">parent</span> <span class="ow">and</span> \
                    <span class="n">dep</span><span class="o">.</span><span class="n">inherit_condition</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">cols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">sql_util</span><span class="o">.</span><span class="n">_find_columns</span><span class="p">(</span><span class="n">dep</span><span class="o">.</span><span class="n">inherit_condition</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">inherit_condition</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">cols</span> <span class="o">=</span> <span class="n">cols</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">sql_util</span><span class="o">.</span><span class="n">_find_columns</span><span class="p">(</span>
                        <span class="n">parent</span><span class="o">.</span><span class="n">inherit_condition</span><span class="p">))</span>
                    <span class="k">return</span> <span class="n">fk</span><span class="o">.</span><span class="n">parent</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cols</span> <span class="ow">and</span> <span class="n">fk</span><span class="o">.</span><span class="n">column</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cols</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">fk</span><span class="o">.</span><span class="n">parent</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cols</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="n">sorted_</span> <span class="o">=</span> <span class="n">sql_util</span><span class="o">.</span><span class="n">sort_tables</span><span class="p">(</span><span class="n">table_to_mapper</span><span class="p">,</span>
                                       <span class="n">skip_fn</span><span class="o">=</span><span class="n">skip</span><span class="p">,</span>
                                       <span class="n">extra_dependencies</span><span class="o">=</span><span class="n">extra_dependencies</span><span class="p">)</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">sorted_</span><span class="p">:</span>
            <span class="n">ret</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">table_to_mapper</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">_memo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">callable_</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_memoized_values</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_memoized_values</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_memoized_values</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span> <span class="o">=</span> <span class="n">callable_</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">value</span>

    <span class="nd">@util.memoized_property</span>
    <span class="k">def</span> <span class="nf">_table_to_equated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;memoized map of tables to collections of columns to be</span>
<span class="sd">        synchronized upwards to the base mapper.&quot;&quot;&quot;</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sorted_tables</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterate_to_root</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">_inherits_equated_pairs</span> <span class="ow">and</span> \
                        <span class="n">cols</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span>
                            <span class="n">util</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="nb">set</span><span class="o">.</span><span class="n">union</span><span class="p">,</span>
                                        <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">proxy_set</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span>
                                         <span class="n">m</span><span class="o">.</span><span class="n">_inherits_equated_pairs</span><span class="p">])</span>
                        <span class="p">):</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">table</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">m</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">_inherits_equated_pairs</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">configure_mappers</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Initialize the inter-mapper relationships of all mappers that</span>
<span class="sd">    have been constructed thus far.</span>

<span class="sd">    This function can be called any number of times, but in</span>
<span class="sd">    most cases is invoked automatically, the first time mappings are used,</span>
<span class="sd">    as well as whenever mappings are used and additional not-yet-configured</span>
<span class="sd">    mappers have been constructed.</span>

<span class="sd">    Points at which this occur include when a mapped class is instantiated</span>
<span class="sd">    into an instance, as well as when the :meth:`.Session.query` method</span>
<span class="sd">    is used.</span>

<span class="sd">    The :func:`.configure_mappers` function provides several event hooks</span>
<span class="sd">    that can be used to augment its functionality.  These methods include:</span>

<span class="sd">    * :meth:`.MapperEvents.before_configured` - called once before</span>
<span class="sd">      :func:`.configure_mappers` does any work; this can be used to establish</span>
<span class="sd">      additional options, properties, or related mappings before the operation</span>
<span class="sd">      proceeds.</span>

<span class="sd">    * :meth:`.MapperEvents.mapper_configured` - called as each indivudal</span>
<span class="sd">      :class:`.Mapper` is configured within the process; will include all</span>
<span class="sd">      mapper state except for backrefs set up by other mappers that are still</span>
<span class="sd">      to be configured.</span>

<span class="sd">    * :meth:`.MapperEvents.after_configured` - called once after</span>
<span class="sd">      :func:`.configure_mappers` is complete; at this stage, all</span>
<span class="sd">      :class:`.Mapper` objects that are known  to SQLAlchemy will be fully</span>
<span class="sd">      configured.  Note that the calling application may still have other</span>
<span class="sd">      mappings that haven&#39;t been produced yet, such as if they are in modules</span>
<span class="sd">      as yet unimported.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">Mapper</span><span class="o">.</span><span class="n">_new_mappers</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">_CONFIGURE_MUTEX</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">global</span> <span class="n">_already_compiling</span>
        <span class="k">if</span> <span class="n">_already_compiling</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">_already_compiling</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="c"># double-check inside mutex</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">Mapper</span><span class="o">.</span><span class="n">_new_mappers</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="n">Mapper</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">_for_class</span><span class="p">(</span><span class="n">Mapper</span><span class="p">)</span><span class="o">.</span><span class="n">before_configured</span><span class="p">()</span>
            <span class="c"># initialize properties on all mappers</span>
            <span class="c"># note that _mapper_registry is unordered, which</span>
            <span class="c"># may randomly conceal/reveal issues related to</span>
            <span class="c"># the order of mapper compilation</span>

            <span class="k">for</span> <span class="n">mapper</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">_mapper_registry</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mapper</span><span class="p">,</span> <span class="s">&#39;_configure_failed&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
                    <span class="n">e</span> <span class="o">=</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
                        <span class="s">&quot;One or more mappers failed to initialize - &quot;</span>
                        <span class="s">&quot;can&#39;t proceed with initialization of other &quot;</span>
                        <span class="s">&quot;mappers.  Original exception was: </span><span class="si">%s</span><span class="s">&quot;</span>
                        <span class="o">%</span> <span class="n">mapper</span><span class="o">.</span><span class="n">_configure_failed</span><span class="p">)</span>
                    <span class="n">e</span><span class="o">.</span><span class="n">_configure_failed</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="n">_configure_failed</span>
                    <span class="k">raise</span> <span class="n">e</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">mapper</span><span class="o">.</span><span class="n">configured</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">mapper</span><span class="o">.</span><span class="n">_post_configure_properties</span><span class="p">()</span>
                        <span class="n">mapper</span><span class="o">.</span><span class="n">_expire_memoizations</span><span class="p">()</span>
                        <span class="n">mapper</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">mapper_configured</span><span class="p">(</span>
                            <span class="n">mapper</span><span class="p">,</span> <span class="n">mapper</span><span class="o">.</span><span class="n">class_</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">exc</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="s">&#39;_configure_failed&#39;</span><span class="p">):</span>
                            <span class="n">mapper</span><span class="o">.</span><span class="n">_configure_failed</span> <span class="o">=</span> <span class="n">exc</span>
                        <span class="k">raise</span>

            <span class="n">Mapper</span><span class="o">.</span><span class="n">_new_mappers</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">_already_compiling</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">_CONFIGURE_MUTEX</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
    <span class="n">Mapper</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">_for_class</span><span class="p">(</span><span class="n">Mapper</span><span class="p">)</span><span class="o">.</span><span class="n">after_configured</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">reconstructor</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorate a method as the &#39;reconstructor&#39; hook.</span>

<span class="sd">    Designates a method as the &quot;reconstructor&quot;, an ``__init__``-like</span>
<span class="sd">    method that will be called by the ORM after the instance has been</span>
<span class="sd">    loaded from the database or otherwise reconstituted.</span>

<span class="sd">    The reconstructor will be invoked with no arguments.  Scalar</span>
<span class="sd">    (non-collection) database-mapped attributes of the instance will</span>
<span class="sd">    be available for use within the function.  Eagerly-loaded</span>
<span class="sd">    collections are generally not yet available and will usually only</span>
<span class="sd">    contain the first element.  ORM state changes made to objects at</span>
<span class="sd">    this stage will not be recorded for the next flush() operation, so</span>
<span class="sd">    the activity within a reconstructor should be conservative.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fn</span><span class="o">.</span><span class="n">__sa_reconstructor__</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="n">fn</span>


<span class="k">def</span> <span class="nf">validates</span><span class="p">(</span><span class="o">*</span><span class="n">names</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorate a method as a &#39;validator&#39; for one or more named properties.</span>

<span class="sd">    Designates a method as a validator, a method which receives the</span>
<span class="sd">    name of the attribute as well as a value to be assigned, or in the</span>
<span class="sd">    case of a collection, the value to be added to the collection.</span>
<span class="sd">    The function can then raise validation exceptions to halt the</span>
<span class="sd">    process from continuing (where Python&#39;s built-in ``ValueError``</span>
<span class="sd">    and ``AssertionError`` exceptions are reasonable choices), or can</span>
<span class="sd">    modify or replace the value before proceeding. The function should</span>
<span class="sd">    otherwise return the given value.</span>

<span class="sd">    Note that a validator for a collection **cannot** issue a load of that</span>
<span class="sd">    collection within the validation routine - this usage raises</span>
<span class="sd">    an assertion to avoid recursion overflows.  This is a reentrant</span>
<span class="sd">    condition which is not supported.</span>

<span class="sd">    :param \*names: list of attribute names to be validated.</span>
<span class="sd">    :param include_removes: if True, &quot;remove&quot; events will be</span>
<span class="sd">     sent as well - the validation function must accept an additional</span>
<span class="sd">     argument &quot;is_remove&quot; which will be a boolean.</span>

<span class="sd">     .. versionadded:: 0.7.7</span>
<span class="sd">    :param include_backrefs: defaults to ``True``; if ``False``, the</span>
<span class="sd">     validation function will not emit if the originator is an attribute</span>
<span class="sd">     event related via a backref.  This can be used for bi-directional</span>
<span class="sd">     :func:`.validates` usage where only one validator should emit per</span>
<span class="sd">     attribute operation.</span>

<span class="sd">     .. versionadded:: 0.9.0</span>

<span class="sd">    .. seealso::</span>

<span class="sd">      :ref:`simple_validators` - usage examples for :func:`.validates`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">include_removes</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;include_removes&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">include_backrefs</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;include_backrefs&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
        <span class="n">fn</span><span class="o">.</span><span class="n">__sa_validators__</span> <span class="o">=</span> <span class="n">names</span>
        <span class="n">fn</span><span class="o">.</span><span class="n">__sa_validation_opts__</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&quot;include_removes&quot;</span><span class="p">:</span> <span class="n">include_removes</span><span class="p">,</span>
            <span class="s">&quot;include_backrefs&quot;</span><span class="p">:</span> <span class="n">include_backrefs</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">fn</span>
    <span class="k">return</span> <span class="n">wrap</span>


<span class="k">def</span> <span class="nf">_event_on_load</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="n">instrumenting_mapper</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">_INSTRUMENTOR</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">instrumenting_mapper</span><span class="o">.</span><span class="n">_reconstructor</span><span class="p">:</span>
        <span class="n">instrumenting_mapper</span><span class="o">.</span><span class="n">_reconstructor</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">obj</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">_event_on_first_init</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="n">cls</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initial mapper compilation trigger.</span>

<span class="sd">    instrumentation calls this one when InstanceState</span>
<span class="sd">    is first generated, and is needed for legacy mutable</span>
<span class="sd">    attributes to work.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">instrumenting_mapper</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_INSTRUMENTOR</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">instrumenting_mapper</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">Mapper</span><span class="o">.</span><span class="n">_new_mappers</span><span class="p">:</span>
            <span class="n">configure_mappers</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_event_on_init</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run init_instance hooks.</span>

<span class="sd">    This also includes mapper compilation, normally not needed</span>
<span class="sd">    here but helps with some piecemeal configuration</span>
<span class="sd">    scenarios (such as in the ORM tutorial).</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">instrumenting_mapper</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_INSTRUMENTOR</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">instrumenting_mapper</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">Mapper</span><span class="o">.</span><span class="n">_new_mappers</span><span class="p">:</span>
            <span class="n">configure_mappers</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">instrumenting_mapper</span><span class="o">.</span><span class="n">_set_polymorphic_identity</span><span class="p">:</span>
            <span class="n">instrumenting_mapper</span><span class="o">.</span><span class="n">_set_polymorphic_identity</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_ColumnMapping</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Error reporting helper for mapper._columntoproperty.&quot;&quot;&quot;</span>

    <span class="n">__slots__</span> <span class="o">=</span> <span class="s">&#39;mapper&#39;</span><span class="p">,</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapper</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span> <span class="o">=</span> <span class="n">mapper</span>

    <span class="k">def</span> <span class="nf">__missing__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">):</span>
        <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prop</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">orm_exc</span><span class="o">.</span><span class="n">UnmappedColumnError</span><span class="p">(</span>
                <span class="s">&quot;Column &#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39; is not available, due to &quot;</span>
                <span class="s">&quot;conflicting property &#39;</span><span class="si">%s</span><span class="s">&#39;:</span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">column</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">column</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">column</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">prop</span><span class="p">))</span>
        <span class="k">raise</span> <span class="n">orm_exc</span><span class="o">.</span><span class="n">UnmappedColumnError</span><span class="p">(</span>
            <span class="s">&quot;No column </span><span class="si">%s</span><span class="s"> is configured on mapper </span><span class="si">%s</span><span class="s">...&quot;</span> <span class="o">%</span>
            <span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span><span class="p">))</span>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Chris Tabor.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>